<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>5&nbsp; Tips and tricks for vectors – Spatial Data Processing with R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./rasters_tips.html" rel="next">
<link href="./coordinate_reference_systems.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>a {text-decoration:none;}
.map-padding { padding: 0 0 2em 0; }</style>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./vectors_tips.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Tips and tricks for vectors</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Data Processing with R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/jguelat/spatial-r" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./vector_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Vector data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./raster_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Raster data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./coordinate_reference_systems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Coordinate reference systems</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./vectors_tips.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Tips and tricks for vectors</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rasters_tips.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Tips and tricks for rasters</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./static_maps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Static maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dynamic_maps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Dynamic maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r_and_qgis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Using QGIS via R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./getting_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Getting data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./more_help.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">More help</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
   
  <ul>
  <li><a href="#reading-vector-data" id="toc-reading-vector-data" class="nav-link active" data-scroll-target="#reading-vector-data"><span class="header-section-number">5.1</span> Reading vector data</a>
  <ul class="collapse">
  <li><a href="#import-a-geopackage" id="toc-import-a-geopackage" class="nav-link" data-scroll-target="#import-a-geopackage"><span class="header-section-number">5.1.1</span> Import a GeoPackage</a></li>
  <li><a href="#import-a-shapefile" id="toc-import-a-shapefile" class="nav-link" data-scroll-target="#import-a-shapefile"><span class="header-section-number">5.1.2</span> Import a Shapefile</a></li>
  <li><a href="#import-a-csv-file-with-coordinates" id="toc-import-a-csv-file-with-coordinates" class="nav-link" data-scroll-target="#import-a-csv-file-with-coordinates"><span class="header-section-number">5.1.3</span> Import a CSV file with coordinates</a></li>
  <li><a href="#import-from-a-postgis-database" id="toc-import-from-a-postgis-database" class="nav-link" data-scroll-target="#import-from-a-postgis-database"><span class="header-section-number">5.1.4</span> Import from a PostGIS database</a></li>
  <li><a href="#import-from-wkb" id="toc-import-from-wkb" class="nav-link" data-scroll-target="#import-from-wkb"><span class="header-section-number">5.1.5</span> Import from WKB</a></li>
  </ul></li>
  <li><a href="#writing-vector-data" id="toc-writing-vector-data" class="nav-link" data-scroll-target="#writing-vector-data"><span class="header-section-number">5.2</span> Writing vector data</a>
  <ul class="collapse">
  <li><a href="#export-to-geopackage" id="toc-export-to-geopackage" class="nav-link" data-scroll-target="#export-to-geopackage"><span class="header-section-number">5.2.1</span> Export to GeoPackage</a></li>
  <li><a href="#export-to-csv" id="toc-export-to-csv" class="nav-link" data-scroll-target="#export-to-csv"><span class="header-section-number">5.2.2</span> Export to CSV</a></li>
  <li><a href="#export-to-shapefile" id="toc-export-to-shapefile" class="nav-link" data-scroll-target="#export-to-shapefile"><span class="header-section-number">5.2.3</span> Export to Shapefile</a></li>
  </ul></li>
  <li><a href="#basic-geometric-computations" id="toc-basic-geometric-computations" class="nav-link" data-scroll-target="#basic-geometric-computations"><span class="header-section-number">5.3</span> Basic geometric computations</a>
  <ul class="collapse">
  <li><a href="#areas-and-lengths" id="toc-areas-and-lengths" class="nav-link" data-scroll-target="#areas-and-lengths"><span class="header-section-number">5.3.1</span> Areas and lengths</a></li>
  <li><a href="#centroids" id="toc-centroids" class="nav-link" data-scroll-target="#centroids"><span class="header-section-number">5.3.2</span> Centroids</a></li>
  <li><a href="#extract-coordinates" id="toc-extract-coordinates" class="nav-link" data-scroll-target="#extract-coordinates"><span class="header-section-number">5.3.3</span> Extract coordinates</a></li>
  <li><a href="#common-pitfalls" id="toc-common-pitfalls" class="nav-link" data-scroll-target="#common-pitfalls"><span class="header-section-number">5.3.4</span> Common pitfalls</a></li>
  </ul></li>
  <li><a href="#geometric-validity" id="toc-geometric-validity" class="nav-link" data-scroll-target="#geometric-validity"><span class="header-section-number">5.4</span> Geometric validity</a></li>
  <li><a href="#sec-typecasting" id="toc-sec-typecasting" class="nav-link" data-scroll-target="#sec-typecasting"><span class="header-section-number">5.5</span> Vector type casting</a>
  <ul class="collapse">
  <li><a href="#polygons-to-multipolygons" id="toc-polygons-to-multipolygons" class="nav-link" data-scroll-target="#polygons-to-multipolygons"><span class="header-section-number">5.5.1</span> Polygons to Multipolygons</a></li>
  <li><a href="#polygons-to-other-types" id="toc-polygons-to-other-types" class="nav-link" data-scroll-target="#polygons-to-other-types"><span class="header-section-number">5.5.2</span> Polygons to other types</a></li>
  <li><a href="#points-to-lines" id="toc-points-to-lines" class="nav-link" data-scroll-target="#points-to-lines"><span class="header-section-number">5.5.3</span> Points to lines</a></li>
  <li><a href="#lines-to-polygons" id="toc-lines-to-polygons" class="nav-link" data-scroll-target="#lines-to-polygons"><span class="header-section-number">5.5.4</span> Lines to polygons</a></li>
  </ul></li>
  <li><a href="#spatial-predicates" id="toc-spatial-predicates" class="nav-link" data-scroll-target="#spatial-predicates"><span class="header-section-number">5.6</span> Spatial predicates</a></li>
  <li><a href="#spatial-subsetting" id="toc-spatial-subsetting" class="nav-link" data-scroll-target="#spatial-subsetting"><span class="header-section-number">5.7</span> Spatial subsetting</a></li>
  <li><a href="#spatial-joins" id="toc-spatial-joins" class="nav-link" data-scroll-target="#spatial-joins"><span class="header-section-number">5.8</span> Spatial joins</a></li>
  <li><a href="#distance-operations" id="toc-distance-operations" class="nav-link" data-scroll-target="#distance-operations"><span class="header-section-number">5.9</span> Distance operations</a></li>
  <li><a href="#buffers" id="toc-buffers" class="nav-link" data-scroll-target="#buffers"><span class="header-section-number">5.10</span> Buffers</a></li>
  <li><a href="#affine-transformations" id="toc-affine-transformations" class="nav-link" data-scroll-target="#affine-transformations"><span class="header-section-number">5.11</span> Affine transformations</a></li>
  <li><a href="#combine-geometries" id="toc-combine-geometries" class="nav-link" data-scroll-target="#combine-geometries"><span class="header-section-number">5.12</span> Combine geometries</a>
  <ul class="collapse">
  <li><a href="#merge-geometries" id="toc-merge-geometries" class="nav-link" data-scroll-target="#merge-geometries"><span class="header-section-number">5.12.1</span> Merge geometries</a></li>
  <li><a href="#intersect-geometries" id="toc-intersect-geometries" class="nav-link" data-scroll-target="#intersect-geometries"><span class="header-section-number">5.12.2</span> Intersect geometries</a></li>
  <li><a href="#erase-geometries" id="toc-erase-geometries" class="nav-link" data-scroll-target="#erase-geometries"><span class="header-section-number">5.12.3</span> Erase geometries</a></li>
  </ul></li>
  <li><a href="#aggregate-by-attributes" id="toc-aggregate-by-attributes" class="nav-link" data-scroll-target="#aggregate-by-attributes"><span class="header-section-number">5.13</span> Aggregate by attributes</a></li>
  <li><a href="#generate-sample-points" id="toc-generate-sample-points" class="nav-link" data-scroll-target="#generate-sample-points"><span class="header-section-number">5.14</span> Generate sample points</a></li>
  <li><a href="#convex-and-concave-hulls" id="toc-convex-and-concave-hulls" class="nav-link" data-scroll-target="#convex-and-concave-hulls"><span class="header-section-number">5.15</span> Convex and concave hulls</a></li>
  <li><a href="#neighborhood-analyses" id="toc-neighborhood-analyses" class="nav-link" data-scroll-target="#neighborhood-analyses"><span class="header-section-number">5.16</span> Neighborhood analyses</a></li>
  <li><a href="#geocoding" id="toc-geocoding" class="nav-link" data-scroll-target="#geocoding"><span class="header-section-number">5.17</span> Geocoding</a></li>
  <li><a href="#crs-transformations" id="toc-crs-transformations" class="nav-link" data-scroll-target="#crs-transformations"><span class="header-section-number">5.18</span> CRS transformations</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Tips and tricks for vectors</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="reading-vector-data" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="reading-vector-data"><span class="header-section-number">5.1</span> Reading vector data</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>We had a look at the gory details of the internal structure <code>sf</code> objects. However most of the time you will not create such objects on your own but rather rely on the <code>sf</code> package to create the right structure when you import existing GIS data. The <code>sf</code> package is using the GDAL (Geospatial Data Abstraction Library) library to read GIS files, and this means you will be able to import almost all existing GIS vector formats. If you want to check all the available formats, you can use the <code>st_drivers()</code> function. Sometimes you will not get a standard GIS data set but a simple CSV (or Excel) file containing coordinates and related attributes. We will now see how to import these different data types in order to use them with the <code>sf</code> package.</p>
<section id="import-a-geopackage" class="level3" data-number="5.1.1">
<h3 data-number="5.1.1" class="anchored" data-anchor-id="import-a-geopackage"><span class="header-section-number">5.1.1</span> Import a GeoPackage</h3>
<p>The GeoPackage format is the best available open format to store vector data. It is based on the SQLite database format which is the most used file-based database nowadays. You can think of it as a special folder containing one or several GIS data sets. Since we normally don’t know in advance if a GeoPackage contains one or more data sets, we first have to inspect it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_layers</span>(<span class="st">"data/geodata.gpkg"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Driver: GPKG 
Available layers:
      layer_name     geometry_type features fields       crs_name
1        streets Multi Line String     7690      3 CH1903+ / LV95
2      landcover     Multi Polygon     1038      2 CH1903+ / LV95
3      buildings     Multi Polygon    14125      2 CH1903+ / LV95
4 municipalities     Multi Polygon        7      3 CH1903+ / LV95
5            wtf           Polygon        3      0 CH1903+ / LV95
6        cantons  3D Multi Polygon       26      2 CH1903+ / LV95</code></pre>
</div>
</div>
<p>You should not always trust the reported number of features. Some GIS format such as the GeoPackage report this number, some don’t. If the GeoPackage was produced by a software that doesn’t properly implement the standard, the reported number of features could be wrong (but this shouldn’t have any other bad consequence). If you want to be sure to get the correct number, you can use the <code>do_count = TRUE</code> argument of the <code>st_layers()</code> function, but this will be slower.</p>
<p>To read the data, you use the <code>st_read()</code> function, the first argument is the path of the GeoPackage, and the second argument is the layer you want to import. The function will return an <code>sf</code> object. By default you’ll get some information about the data being imported. If you don’t need them, you can use the argument <code>quiet = TRUE</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>muni <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"municipalities"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `municipalities' from data source 
  `C:\Users\jgu\Desktop\Spatial Data Processing with R\data\geodata.gpkg' 
  using driver `GPKG'
Simple feature collection with 7 features and 3 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 2648317 ymin: 1213352 xmax: 2660750 ymax: 1227618
Projected CRS: CH1903+ / LV95</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>streets <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"streets"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s check the object we’ve just created. To inspect <code>sf</code> objects, you can either call them directly or use the <code>print()</code> function. The <code>head()</code> and <code>tail()</code> functions will also work since <code>sf</code> objects are based on data frames. By default, only the first 10 rows will be displayed. If you want to see more (or less) rows, use the <code>n</code> argument of the <code>print()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>muni</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 7 features and 3 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 2648317 ymin: 1213352 xmax: 2660750 ymax: 1227618
Projected CRS: CH1903+ / LV95
   bfs       name popsize                           geom
1 1093 Neuenkirch    7194 MULTIPOLYGON (((2654554 121...
2 1094    Nottwil    4089 MULTIPOLYGON (((2654554 121...
3 1102    Sempach    4186 MULTIPOLYGON (((2656062 121...
4 1095  Oberkirch    5014 MULTIPOLYGON (((2649729 122...
5 1084       Eich    1610 MULTIPOLYGON (((2654640 122...
6 1099   Schenkon    3088 MULTIPOLYGON (((2652397 122...
7 1103     Sursee   10382 MULTIPOLYGON (((2648801 122...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(muni, <span class="at">n =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 7 features and 3 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 2648317 ymin: 1213352 xmax: 2660750 ymax: 1227618
Projected CRS: CH1903+ / LV95
First 2 features:
   bfs       name popsize                           geom
1 1093 Neuenkirch    7194 MULTIPOLYGON (((2654554 121...
2 1094    Nottwil    4089 MULTIPOLYGON (((2654554 121...</code></pre>
</div>
</div>
<p>The output contains basic information about the data set, and the first features are shown with all the attributes. This municipalities data set is an extract of the <a href="https://www.swisstopo.admin.ch/en/landscape-model-swissboundaries3d" target="_blank">swissBOUNDARIES3D</a> data set provided by Swisstopo, the streets data set is an extract of the <a href="https://www.swisstopo.admin.ch/en/landscape-model-swisstlm3d" target="_blank">swissTLM3D</a> data set, also provided by Swisstopo.</p>
</section>
<section id="import-a-shapefile" class="level3" data-number="5.1.2">
<h3 data-number="5.1.2" class="anchored" data-anchor-id="import-a-shapefile"><span class="header-section-number">5.1.2</span> Import a Shapefile</h3>
<p>If you really need to import a Shapefile, you should also use the <code>st_read()</code> function. Since Shapefiles cannot contain more than one data set, we only need to provide the first argument of the function. A Shapefile consists of several files with different extensions (.shp, .shx, etc.), we use the .shp extension by default when importing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>muni2 <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/municipalities.shp"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>muni2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 7 features and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 2648317 ymin: 1213352 xmax: 2660750 ymax: 1227618
Projected CRS: CH1903+ / LV95
  fid  bfs       name                       geometry
1   1 1093 Neuenkirch POLYGON ((2654554 1217985, ...
2   2 1094    Nottwil POLYGON ((2654554 1217985, ...
3   3 1102    Sempach POLYGON ((2656062 1219916, ...
4   4 1095  Oberkirch POLYGON ((2649729 1221262, ...
5   5 1084       Eich POLYGON ((2654640 1224638, ...
6   6 1099   Schenkon POLYGON ((2652397 1224195, ...
7   7 1103     Sursee POLYGON ((2648801 1225672, ...</code></pre>
</div>
</div>
<p>This is actually the same data set as the one in the GeoPackage, however, note that <code>sf</code> is now using polygons instead of multipolygons. This is caused by the fact that the Shapefile format does not distinguish properly between the two types. The GDAL library will use the type polygons in this case, but you can still have a combination of polygons and multipolygons in the same data set.</p>
</section>
<section id="import-a-csv-file-with-coordinates" class="level3" data-number="5.1.3">
<h3 data-number="5.1.3" class="anchored" data-anchor-id="import-a-csv-file-with-coordinates"><span class="header-section-number">5.1.3</span> Import a CSV file with coordinates</h3>
<p>If you have a table containing coordinates of point data (e.g.&nbsp;sites or bird sightings), you should use the <code>st_as_sf()</code> function. The first argument should be the data frame containing the data, and you also need to specify the names (or the numbers) of the columns containing the geographic coordinates, and the CRS used. The following data set was extracted from the bird sightings database of the Swiss Ornithological Institute.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/observations.csv"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  species_id               name       date       x       y
1       4240 Eurasian Blackbird 2022-04-12 2658433 1220946
2       3800  Eurasian Blue Tit 2022-04-12 2658442 1221138
3       4240 Eurasian Blackbird 2022-05-09 2658607 1221189
4       4240 Eurasian Blackbird 2022-05-09 2658597 1221137
5       4240 Eurasian Blackbird 2022-05-09 2658569 1220956
6       3800  Eurasian Blue Tit 2022-05-09 2658476 1220904</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(obs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>obs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 530 features and 3 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 2649549 ymin: 1218571 xmax: 2660110 ymax: 1225531
Projected CRS: CH1903+ / LV95
First 10 features:
   species_id               name       date                geometry
1        4240 Eurasian Blackbird 2022-04-12 POINT (2658433 1220946)
2        3800  Eurasian Blue Tit 2022-04-12 POINT (2658442 1221138)
3        4240 Eurasian Blackbird 2022-05-09 POINT (2658607 1221189)
4        4240 Eurasian Blackbird 2022-05-09 POINT (2658597 1221137)
5        4240 Eurasian Blackbird 2022-05-09 POINT (2658569 1220956)
6        3800  Eurasian Blue Tit 2022-05-09 POINT (2658476 1220904)
7        4240 Eurasian Blackbird 2022-05-09 POINT (2658514 1221205)
8        3800  Eurasian Blue Tit 2022-05-09 POINT (2658517 1221195)
9        4240 Eurasian Blackbird 2022-05-23 POINT (2658570 1221219)
10       4240 Eurasian Blackbird 2022-05-23 POINT (2658455 1220911)</code></pre>
</div>
</div>
<p>If you have data in WGS84, your geometry columns will probably be named longitude and latitude. In this case remember that longitude corresponds to the <em>x</em> coordinate and latitude to the <em>y</em> coordinate. This can be sometimes confusing because most geographic CRSs have a “reversed” axis order (which means latitude is stored before longitude). To be honest the situation is even more complicated than that, since in geodesy, the convention is to let the x axis point to the North and the y axis to the East (more information: <a href="https://wiki.osgeo.org/wiki/Axis_Order_Confusion" target="_blank">https://wiki.osgeo.org/wiki/Axis_Order_Confusion</a>).</p>
<p>Fortunately, thanks to the great job done by the programmers of the PROJ and GDAL libraries, you don’t really have to think about all this chaos. Just remember the rule mentioned above and you should be safe 99.99% of the time. You should thus use (note the different value for the <code>crs</code> argument):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>obs_wgs <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/observations_wgs.csv"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>obs_wgs <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(obs_wgs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="import-from-a-postgis-database" class="level3" data-number="5.1.4">
<h3 data-number="5.1.4" class="anchored" data-anchor-id="import-from-a-postgis-database"><span class="header-section-number">5.1.4</span> Import from a PostGIS database</h3>
<p>PostGIS is a famous open-source extension for the PostgreSQL database management system. It allows storing all kind of GIS data inside a database and perform hundreds of typical GIS analyses. The Swiss Ornithological Institute is using PostGIS to store almost all its bird data and a lot of other GIS data sets. If you have a laptop provided by the institute and you already accessed our database via QGIS, you should be able to run the following code. The process will be the same for all PostGIS databases.</p>
<p>First we need to load the <code>RPostgres</code> package which provides function to access PostgreSQL databases (and hence PostGIS, too). There is another package providing similar functionality called <code>RPostgreSQL</code>, but in my opinion the <code>RPostgres</code> is better maintained and I experienced less problems.</p>
<p>After storing all the connection details in some variables, we can finally create a connection to the database using the <code>dbConnect()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RPostgres)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Login data</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>user <span class="ot">&lt;-</span> <span class="st">"replace_with_your_login"</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>password <span class="ot">&lt;-</span> <span class="st">"replace_with_your_password"</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>host <span class="ot">&lt;-</span> <span class="st">"dbspatialdata1"</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>database <span class="ot">&lt;-</span> <span class="st">"research"</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Connection to the database</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>dbcon <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">Postgres</span>(), <span class="at">dbname =</span> database, <span class="at">host =</span> host, <span class="at">user =</span> user, <span class="at">password =</span> password)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After that we need to import the data with a query, using again the <code>st_read()</code> function. Note that the first argument of the function must be the database connection object. The first possibility consists of importing the whole layer (called table in the database lingo) with all its attributes. This is what we do for the <code>cantons1</code> data set. We need to use the <code>Id()</code> function to specify the location of the table inside the database. In a PostgreSQL database, a schema is a bit like a folder where we store tables, this allows us to implement some structure inside the database. In our case the table <code>cantonal_boundaries_ch</code> is stored inside the schema <code>perimeter</code>. Note that we don’t need the <code>Id()</code> function if the table are stored in the <code>public</code> schema.</p>
<p>We can also specify a SQL query to import the data, like for the <code>cantons2</code> data set. Using this kind of query, we are fully flexible. We can for example specify the attributes we want to import, specific data filters, we can even join different tables together (by attributes or even spatially). Once again we have to specify the schema, but this is done a bit differently.</p>
<p>Once we have our <code>sf</code> objects, we still need to disconnect the database. The cantonal_boundaries_ch data set contains all the cantonal boundaries in Switzerland. The data is provided by Swisstopo (<a href="https://www.swisstopo.admin.ch/en/landscape-model-swissboundaries3d" target="_blank">swissBOUNDARIES3D</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load cantonal boundaries</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>cantons1 <span class="ot">&lt;-</span> <span class="fu">st_read</span>(dbcon, <span class="at">layer =</span> <span class="fu">Id</span>(<span class="at">schema =</span> <span class="st">"perimeter"</span>, <span class="at">table =</span> <span class="st">"cantonal_boundaries_ch"</span>))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>cantons2 <span class="ot">&lt;-</span> <span class="fu">st_read</span>(dbcon, <span class="at">query =</span> <span class="st">"SELECT id, name, geom</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="st">                                    FROM perimeter.cantonal_boundaries_ch</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="st">                                    WHERE name = 'Fribourg'"</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Disconnect database</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(dbcon)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Show sf objects</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>cantons1</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>cantons2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="import-from-wkb" class="level3" data-number="5.1.5">
<h3 data-number="5.1.5" class="anchored" data-anchor-id="import-from-wkb"><span class="header-section-number">5.1.5</span> Import from WKB</h3>
<p>You probably won’t need to import geometries in the WKB format very often. GIS data should not be shared directly in this format. However, since it’s the default format used to store geometries in the PostGIS database, you will maybe get one day a table with attributes and a single WKB column. The following table is a direct extract from a PostGIS database.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>obs_wkb <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/observations_wkb.csv"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(obs_wkb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  species_id               name       date
1       3800  Eurasian Blue Tit 2020-12-07
2       3800  Eurasian Blue Tit 2020-04-13
3       3800  Eurasian Blue Tit 2020-09-12
4       4240 Eurasian Blackbird 2020-10-22
5       4240 Eurasian Blackbird 2020-07-04
6       3800  Eurasian Blue Tit 2020-02-02
                                                 wkb
1 01010000200808000000000000DD3D444100000000FCA13241
2 01010000200808000000000000C63D44410000000030A23241
3 01010000200808000000000000E03F44410000000059953241
4 010100002008080000000000001D3E44410000000077A13241
5 010100002008080000000000009E3E4441000000007CA33241
6 01010000200808000000000000E83C4441000000001CA43241</code></pre>
</div>
</div>
<p>Unfortunately it is not possible to use the <code>st_read()</code> function to import such data, and the <code>st_as_sf()</code> function won’t work either. In this case we need to first convert the WKB geometries into <code>sfc</code> objects. To do that we need to add an extra attribute using the <code>structure()</code> function to inform <code>sf</code> that we’re using WKB geometries. After that we can use the <code>st_as_sfc()</code> function. The <code>EWKB = TRUE</code> means that we are using a WKB dialect called EWKB (Extended WKB) which also includes the SRID of the geometries. Once we have a vector of <code>sfc</code> objects, we remove the now useless column containing the WKB geometries and use the <code>st_sf()</code> function to combine the data frame with the geometries.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>geom <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(<span class="fu">structure</span>(<span class="fu">as.list</span>(obs_wkb<span class="sc">$</span>wkb), <span class="at">class =</span> <span class="st">"WKB"</span>), <span class="at">EWKB =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>obs_wkb <span class="ot">&lt;-</span> <span class="fu">subset</span>(obs_wkb, <span class="at">select =</span> <span class="sc">-</span>wkb)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>obs_wkb <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(obs_wkb, geom)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>obs_wkb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 21 features and 3 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 2652408 ymin: 1217881 xmax: 2654144 ymax: 1221958
Projected CRS: CH1903+ / LV95
First 10 features:
   species_id               name       date                    geom
1        3800  Eurasian Blue Tit 2020-12-07 POINT (2653114 1221116)
2        3800  Eurasian Blue Tit 2020-04-13 POINT (2653068 1221168)
3        3800  Eurasian Blue Tit 2020-09-12 POINT (2654144 1217881)
4        4240 Eurasian Blackbird 2020-10-22 POINT (2653242 1220983)
5        4240 Eurasian Blackbird 2020-07-04 POINT (2653500 1221500)
6        3800  Eurasian Blue Tit 2020-02-02 POINT (2652624 1221660)
7        4240 Eurasian Blackbird 2020-04-10 POINT (2653388 1218372)
8        3800  Eurasian Blue Tit 2020-10-22 POINT (2653088 1221156)
9        3800  Eurasian Blue Tit 2020-10-22 POINT (2652943 1221333)
10       3800  Eurasian Blue Tit 2020-10-22 POINT (2653180 1220958)</code></pre>
</div>
</div>
</section>
</section>
<section id="writing-vector-data" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="writing-vector-data"><span class="header-section-number">5.2</span> Writing vector data</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>muni <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"municipalities"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/observations.csv"</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(obs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>When you create or modify a GIS data set with <code>sf</code> you’ll need to export it to some standard GIS format if you want to share it with colleagues, open it in another GIS software, or simply archive it. I do not recommend using R workspaces (.Rdata files) to share or store GIS data. For exporting vector data, we are going to use the <code>st_write()</code> function. Like the <code>st_read()</code> function, it uses the GDAL library, so you’ll be able to export in many different formats. You can specify the format explicitly, otherwise <code>sf</code> will try to guess it based on the file extension. It is also possible to export to a PostGIS database using an approach similar to the one we used for importing.</p>
<section id="export-to-geopackage" class="level3" data-number="5.2.1">
<h3 data-number="5.2.1" class="anchored" data-anchor-id="export-to-geopackage"><span class="header-section-number">5.2.1</span> Export to GeoPackage</h3>
<p>For a GeoPackage, you need to specify the name of the GeoPackage first (it will be automatically created if it doesn’t exist) and the name of the data set that will be stored inside the GeoPackage. If you specify a GeoPackage that already exists, the data set will be added to it as a new table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(obs, <span class="st">"export/birds.gpkg"</span>, <span class="st">"observations"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Writing layer `observations' to data source `export/birds.gpkg' using driver `GPKG'
Writing 530 features with 3 fields and geometry type Point.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>obs2 <span class="ot">&lt;-</span> obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,]</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(obs2, <span class="st">"export/birds.gpkg"</span>, <span class="st">"observations2"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">st_layers</span>(<span class="st">"export/birds.gpkg"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Driver: GPKG 
Available layers:
     layer_name geometry_type features fields       crs_name
1  observations         Point      530      3 CH1903+ / LV95
2 observations2         Point       10      3 CH1903+ / LV95</code></pre>
</div>
</div>
<p>If you want to delete a data set, you can use the <code>st_delete()</code> function. Think twice before doing it, there will be no warning!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_delete</span>(<span class="st">"export/birds.gpkg"</span>, <span class="st">"observations2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Deleting layer `observations2' using driver `GPKG'</code></pre>
</div>
</div>
</section>
<section id="export-to-csv" class="level3" data-number="5.2.2">
<h3 data-number="5.2.2" class="anchored" data-anchor-id="export-to-csv"><span class="header-section-number">5.2.2</span> Export to CSV</h3>
<p>It is usually a better option to export a GeoPackage, but sometimes you’ll still need to export your data to CSV. When you share such a file, always add metadata about the CRS you used. Since CSV is not a GIS format, we need a way to store the geometries. This is easy for point data since we can always add columns with the coordinates. For line and polygon data we need to find another solution, for example store the WKT in a new column.</p>
<p>We can use the <code>layer_options</code> argument of the <code>st_write()</code> function to export point data with the additional columns for the <em>x</em> and <em>y</em> coordinates. These additional options are sent directly to the GDAL library which does the export.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(obs, <span class="st">"export/birds.csv"</span>, <span class="at">layer_options =</span> <span class="st">"GEOMETRY=AS_XY"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Writing layer `birds' to data source `export/birds.csv' using driver `CSV'
options:        GEOMETRY=AS_XY 
Writing 530 features with 3 fields and geometry type Point.</code></pre>
</div>
</div>
<p>For polygon and line data, we can do something similar to get a new column with the WKT geometry. Since commas are used in the WKT format, it might be a good idea to use another separator for the CSV file. Note that you’ll probably get into troubles if your geometries have a lot of vertices.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(muni, <span class="st">"export/municipalities.csv"</span>, <span class="at">layer_options =</span> <span class="fu">c</span>(<span class="st">"GEOMETRY=AS_WKT"</span>, <span class="st">"SEPARATOR=SEMICOLON"</span>), <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="export-to-shapefile" class="level3" data-number="5.2.3">
<h3 data-number="5.2.3" class="anchored" data-anchor-id="export-to-shapefile"><span class="header-section-number">5.2.3</span> Export to Shapefile</h3>
<p>Really??? <a href="figures/simpsons.png" target="_blank">Please don’t</a>!</p>
</section>
</section>
<section id="basic-geometric-computations" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="basic-geometric-computations"><span class="header-section-number">5.3</span> Basic geometric computations</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>muni <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"municipalities"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>streets <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"streets"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>In this section we’ll see how to perform some basic geometric computations on spatial data, such as computing area, perimeter, length and centroids. We’ll also learn how to display the coordinates of <code>sf</code> geometries.</p>
<section id="areas-and-lengths" class="level3" data-number="5.3.1">
<h3 data-number="5.3.1" class="anchored" data-anchor-id="areas-and-lengths"><span class="header-section-number">5.3.1</span> Areas and lengths</h3>
<p>As a first example, let’s how we can compute the area and perimeter of polygons, or the length of lines.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_area</span>(muni)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m^2]
[1] 26267403 14834107 11676584 10954968  9218391  7710103  6050585</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_perimeter</span>(muni)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m]
[1] 29717.62 17281.70 16758.24 15754.38 14897.75 15462.88 13398.87</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">st_length</span>(streets))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m]
[1] 1915.1026  378.9425  345.9435 1836.5854  901.2759  232.4974</code></pre>
</div>
</div>
<p>Note that the results always have a unit of measurement. This is a feature that is provided by <code>sf</code> and will occur will all functions giving some sort of measurement. This is compatible with the <code>units</code> package which allows easy conversions between different unit types. However this can sometimes be a problem if you need a “raw” value. In this case you can use the <code>as.numeric()</code> function to remove the units.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>st_perimeter()</code> function was not available in older versions of the <code>sf</code> package. The <code>lwgeom</code> package was needed to perform this computation.</p>
</div>
</div>
<p>If you use unprojected data (i.e., with a geographic CRS), <code>sf</code> will automatically use the <code>s2</code> library to compute areas, perimeters and lengths.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_area</span>(World[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m^2]
[1] 6.524913e+11 2.965392e+10 2.319313e+12 1.250265e+12 1.223080e+13</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_perimeter</span>(World[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m]
[1]  4552620.2   831564.7  6782465.9  6031452.9 29709970.9</code></pre>
</div>
</div>
<p>The <code>s2</code> library performs its computations on a spheroid. For areas and lengths, it is possible to obtain a better approximation by using an ellipsoid. You can do this by turning off the <code>s2</code> library with the <code>sf_use_s2(FALSE)</code> function. In this case, <code>sf</code> will automatically use equivalent functions provided by the <code>lwgeom</code><span class="citation" data-cites="pebesma_lwgeom_2023"><sup><a href="references.html#ref-pebesma_lwgeom_2023" role="doc-biblioref">1</a></sup></span> package. These functions use algorithms from the GeographicLib library which are to my knowledge the most precise approximations you can currently get. Note that the <code>st_perimeter()</code> function won’t be available if you do that. You’ll need to transform the polygons to lines first (see <a href="#sec-typecasting" class="quarto-xref"><span>Section 5.5</span></a> for details), and then use the <code>st_length()</code> function. Don’t forget to reactivate <code>s2</code> (using the <code>sf_use_s2(TRUE)</code> function) when you’re done.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_use_s2</span>(<span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Spherical geometry (s2) switched off</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_area</span>(World[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m^2]
[1] 6.522790e+11 2.969314e+10 2.315867e+12 1.245470e+12 1.233046e+13</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_length</span>(<span class="fu">st_cast</span>(World[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,], <span class="st">"MULTILINESTRING"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m]
[1]  4553652.7   831351.2  6779702.5  6020175.2 29826094.4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_use_s2</span>(<span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Spherical geometry (s2) switched on</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>You should normally not turn <code>s2</code> off. Computing areas and lengths (and distances, as we will see later) are probably the only valid cases where turning <code>s2</code> off is a good idea. For all other computations based on geographic CRSs you should NOT deactivate <code>s2</code>, otherwise you’ll get results that will most probably be wrong.</p>
</div>
</div>
</section>
<section id="centroids" class="level3" data-number="5.3.2">
<h3 data-number="5.3.2" class="anchored" data-anchor-id="centroids"><span class="header-section-number">5.3.2</span> Centroids</h3>
<p>Computing the centroid of polygons is another useful operation that is easily computed using the <code>st_centroid()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>muni_centroid <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(muni)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: st_centroid assumes attributes are constant over geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(muni))</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(muni_centroid), <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For this example, you can safely ignore the warning about attributes assumed to be constant. The output of the <code>st_centroid()</code> function will be a point data set with the same number of features and the same attributes as the data set used to compute the centroids. The function simply warns you that if the value of some attribute is not constant for some polygon, then the value of this attribute for the centroid probably doesn’t make a lot of sense.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Centroids can be used to place labels inside polygons, but don’t forget that polygons with strange shapes may not contain their own centroid. If you need to be sure that the point will be inside the polygon, use the <code>st_point_on_surface()</code> function.</p>
</div>
</div>
</section>
<section id="extract-coordinates" class="level3" data-number="5.3.3">
<h3 data-number="5.3.3" class="anchored" data-anchor-id="extract-coordinates"><span class="header-section-number">5.3.3</span> Extract coordinates</h3>
<p>Sometimes we also need to know the coordinates of the <code>sf</code> objects we’re using. For points we of course get the coordinates of the points, for lines and polygons we get the coordinates of the vertices, with additional columns showing how to reconstruct the features (check the <code>st_coordinates()</code> help page to understand the meaning of L1, L2 and L3).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_coordinates</span>(muni_centroid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           X       Y
[1,] 2657961 1217280
[2,] 2653276 1220227
[3,] 2657334 1221089
[4,] 2650683 1222874
[5,] 2655114 1223114
[6,] 2652705 1225584
[7,] 2650517 1225371</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">st_coordinates</span>(muni))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           X       Y L1 L2 L3
[1,] 2654554 1217985  1  1  1
[2,] 2654481 1218031  1  1  1
[3,] 2654492 1218051  1  1  1
[4,] 2654495 1218063  1  1  1
[5,] 2654493 1218067  1  1  1
[6,] 2654494 1218083  1  1  1</code></pre>
</div>
</div>
</section>
<section id="common-pitfalls" class="level3" data-number="5.3.4">
<h3 data-number="5.3.4" class="anchored" data-anchor-id="common-pitfalls"><span class="header-section-number">5.3.4</span> Common pitfalls</h3>
<p>Unfortunately geometric computations are not always that easy… Let’s have a look at another example. We load another polygon layer and try to compute the area of each polygon.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>bug <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"wtf"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bug, <span class="at">col =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(bug))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_area</span>(bug)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m^2]
[1] 547988.3 200939.1      0.0</code></pre>
</div>
</div>
<p>Oops, these polygons look big enough but one of them seems to have an area of 0… Why is this happening? To understand the problem, we first need to talk a bit about geometric validity…</p>
</section>
</section>
<section id="geometric-validity" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="geometric-validity"><span class="header-section-number">5.4</span> Geometric validity</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>bug <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"wtf"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>When we had a look a the vector data model, we discovered the Simple Feature standard but we forgot an important part: geometric validity. Validity is defined a bit differently depending on the geometry engine used for the computations. First the good news: points are always valid! Lines are always valid for the GEOS engine used by <code>sf</code> but they are considered invalid by QGIS if they have self-intersections (such lines are called non-simple). Polygons are definitely invalid if they have self-intersections (like our example). The other invalid cases are shown on this website: <a href="https://postgis.net/docs/using_postgis_dbmanagement.html#Valid_Geometry" target="_blank">https://postgis.net/docs/using_postgis_dbmanagement.html#Valid_Geometry</a>. Using invalid geometries can be problematic for some analyses, such as computing areas.</p>
<p>Normally we should expect official data sets to be valid but this is often not the case. You can check the validity of each feature using the <code>st_is_valid()</code> function. If you want a short description of the problems, you can add the argument <code>reason = TRUE</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>bug</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 0 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 2656313 ymin: 1219730 xmax: 2659317 ymax: 1221618
Projected CRS: CH1903+ / LV95
                            geom
1 POLYGON ((2656382 1221396, ...
2 POLYGON ((2656903 1220285, ...
3 POLYGON ((2658317 1221618, ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_is_valid</span>(bug)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  TRUE  TRUE FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_is_valid</span>(bug, <span class="at">reason =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Valid Geometry"                        
[2] "Valid Geometry"                        
[3] "Self-intersection[2658817 1221117.875]"</code></pre>
</div>
</div>
<p>If there are only a few invalid features, we can correct them manually in QGIS. But sometimes this is not feasible and we need some automatic way of correcting. This is where the <code>st_make_valid()</code> function shines. Even though it’s fully automatic, it will perform the appropriate changes 99% of the time. The function can use two different algorithms to correct geometries, you can choose which one will be used with the argument <code>geos_method</code>. The default algorithm (“valid_structure”) is more recent and should produce better results in most cases. Try the older one (“valid_linework”) if you’re not happy with the results. Check the following webpage to see the differences between the two algorithms (it is written for PostGIS but <code>sf</code> uses the same geometry engine): <a href="https://www.crunchydata.com/blog/waiting-for-postgis-3.2-st_makevalid" target="_blank">https://www.crunchydata.com/blog/waiting-for-postgis-3.2-st_makevalid</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>bug_valid <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(bug)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_is_valid</span>(bug_valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE TRUE TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>bug_valid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 0 fields
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: 2656313 ymin: 1219730 xmax: 2659317 ymax: 1221618
Projected CRS: CH1903+ / LV95
                            geom
1 POLYGON ((2656382 1221396, ...
2 POLYGON ((2656903 1220285, ...
3 MULTIPOLYGON (((2658317 122...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_geometry_type</span>(bug_valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] POLYGON      POLYGON      MULTIPOLYGON
18 Levels: GEOMETRY POINT LINESTRING POLYGON MULTIPOINT ... TRIANGLE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_geometry_type</span>(bug_valid, <span class="at">by_geometry =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] GEOMETRY
18 Levels: GEOMETRY POINT LINESTRING POLYGON MULTIPOINT ... TRIANGLE</code></pre>
</div>
</div>
<p>When we look at the corrected data set, we see that the invalid polygon was converted to a multipolygon. We can also check it using the <code>st_geometry_type()</code> function. This is however a problem since we normally don’t want a data set with mixed geometry types. When we use the <code>by_geometry = FALSE</code> argument, we see that <code>sf</code> is now using a generic GEOMETRY type for the data set. The solution would be to convert all the other polygons to multipolygons. To do that we need to understand type casting.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>You’ve maybe heard of the buffer trick. It consists of computing a 0 meter buffer around each geometry to make them valid. This does work and make everything valid, but you may lose some parts of the geometries. For example, if you have a polygon with a self-intersection. The smaller part will not be retained.</p>
</div>
</div>
</section>
<section id="sec-typecasting" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="sec-typecasting"><span class="header-section-number">5.5</span> Vector type casting</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>muni <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"municipalities"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>bug <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"wtf"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>bug_valid <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(bug)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Changing the type of vector features is done with the <code>st_cast()</code> function. Using this function you can not only disaggregate geometries with MULTI* types into several unique features (e.g., multipolygon to polygon) or extract simpler types (e.g., extract polygon borders or vertices), but also construct geometries using “simpler” geometry types (e.g., build a line from points).</p>
<section id="polygons-to-multipolygons" class="level3" data-number="5.5.1">
<h3 data-number="5.5.1" class="anchored" data-anchor-id="polygons-to-multipolygons"><span class="header-section-number">5.5.1</span> Polygons to Multipolygons</h3>
<p>We can now solve our previous problem and convert everything to multipolygons (the existing multipolygon will be left untouched). Using the <code>st_as_text()</code> function we can see the WKT representation of the features geometry, and confirm that we’re now using the same vector type for all features. The <code>st_geometry_type()</code> function also tells us that the data set type is now multipolygon.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>bug_multipoly <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(bug_valid, <span class="at">to =</span> <span class="st">"MULTIPOLYGON"</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_as_text</span>(<span class="fu">st_geometry</span>(bug_valid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "POLYGON ((2656382 1221396, 2657007 1221587, 2657250 1221414, 2657389 1221014, 2656730 1220824, 2656313 1221084, 2656382 1221396))"                            
[2] "POLYGON ((2656903 1220285, 2657441 1220077, 2657632 1220459, 2657754 1220129, 2657458 1219730, 2656903 1220285))"                                             
[3] "MULTIPOLYGON (((2658317 1221618, 2658817 1221118, 2658317 1220618, 2658317 1221618)), ((2658817 1221118, 2659317 1221618, 2659317 1220618, 2658817 1221118)))"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_as_text</span>(<span class="fu">st_geometry</span>(bug_multipoly))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "MULTIPOLYGON (((2656382 1221396, 2657007 1221587, 2657250 1221414, 2657389 1221014, 2656730 1220824, 2656313 1221084, 2656382 1221396)))"                     
[2] "MULTIPOLYGON (((2656903 1220285, 2657441 1220077, 2657632 1220459, 2657754 1220129, 2657458 1219730, 2656903 1220285)))"                                      
[3] "MULTIPOLYGON (((2658317 1221618, 2658817 1221118, 2658317 1220618, 2658317 1221618)), ((2658817 1221118, 2659317 1221618, 2659317 1220618, 2658817 1221118)))"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_geometry_type</span>(bug_multipoly, <span class="at">by_geometry =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] MULTIPOLYGON
18 Levels: GEOMETRY POINT LINESTRING POLYGON MULTIPOINT ... TRIANGLE</code></pre>
</div>
</div>
<p>If you want to be absolutely sure that you have only one feature type in your data set, you can combine the <code>unique()</code> function with the <code>st_geometry_type()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(<span class="fu">st_geometry_type</span>(bug_valid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] POLYGON      MULTIPOLYGON
18 Levels: GEOMETRY POINT LINESTRING POLYGON MULTIPOINT ... TRIANGLE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(<span class="fu">st_geometry_type</span>(bug_multipoly))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] MULTIPOLYGON
18 Levels: GEOMETRY POINT LINESTRING POLYGON MULTIPOINT ... TRIANGLE</code></pre>
</div>
</div>
</section>
<section id="polygons-to-other-types" class="level3" data-number="5.5.2">
<h3 data-number="5.5.2" class="anchored" data-anchor-id="polygons-to-other-types"><span class="header-section-number">5.5.2</span> Polygons to other types</h3>
<p>We can go a bit further and convert our multipolygons to other types. Converting polygons to lines will extract the rings, and converting to points will extract the vertices (similarly, casting a linestring to points will extract its vertices). Note: for some reasons, it is not possible to convert a multipolygon directly to a linestring. You’ll need to convert it to a multilinestring object first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>bug_poly <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(bug_multipoly, <span class="at">to =</span> <span class="st">"POLYGON"</span>)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>bug_multiline <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(bug_multipoly, <span class="at">to =</span> <span class="st">"MULTILINESTRING"</span>)</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>bug_line <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(bug_multiline, <span class="at">to =</span> <span class="st">"LINESTRING"</span>)</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>bug_multipts <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(bug_multipoly, <span class="at">to =</span> <span class="st">"MULTIPOINT"</span>)</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>bug_pts <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(bug_multipoly, <span class="at">to =</span> <span class="st">"POINT"</span>)</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>bug_poly</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 4 features and 0 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 2656313 ymin: 1219730 xmax: 2659317 ymax: 1221618
Projected CRS: CH1903+ / LV95
                            geom
1 POLYGON ((2656382 1221396, ...
2 POLYGON ((2656903 1220285, ...
3 POLYGON ((2658317 1221618, ...
4 POLYGON ((2658817 1221118, ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>bug_multiline</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 0 fields
Geometry type: MULTILINESTRING
Dimension:     XY
Bounding box:  xmin: 2656313 ymin: 1219730 xmax: 2659317 ymax: 1221618
Projected CRS: CH1903+ / LV95
                            geom
1 MULTILINESTRING ((2656382 1...
2 MULTILINESTRING ((2656903 1...
3 MULTILINESTRING ((2658317 1...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>bug_line</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 4 features and 0 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: 2656313 ymin: 1219730 xmax: 2659317 ymax: 1221618
Projected CRS: CH1903+ / LV95
                            geom
1 LINESTRING (2656382 1221396...
2 LINESTRING (2656903 1220285...
3 LINESTRING (2658317 1221618...
4 LINESTRING (2658817 1221118...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>bug_multipts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 0 fields
Geometry type: MULTIPOINT
Dimension:     XY
Bounding box:  xmin: 2656313 ymin: 1219730 xmax: 2659317 ymax: 1221618
Projected CRS: CH1903+ / LV95
                            geom
1 MULTIPOINT ((2656382 122139...
2 MULTIPOINT ((2656903 122028...
3 MULTIPOINT ((2658317 122161...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>bug_pts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 21 features and 0 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 2656313 ymin: 1219730 xmax: 2659317 ymax: 1221618
Projected CRS: CH1903+ / LV95
First 10 features:
                      geom
1  POINT (2656382 1221396)
2  POINT (2657007 1221587)
3  POINT (2657250 1221414)
4  POINT (2657389 1221014)
5  POINT (2656730 1220824)
6  POINT (2656313 1221084)
7  POINT (2656382 1221396)
8  POINT (2656903 1220285)
9  POINT (2657441 1220077)
10 POINT (2657632 1220459)</code></pre>
</div>
</div>
<p>In the following figure, each feature has a unique color. It is thus easy to visualize the difference between the MULTI* types and the other ones.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>))</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(bug_multipoly), <span class="at">col =</span> <span class="fu">rainbow</span>(<span class="fu">nrow</span>(bug_multipoly)), <span class="at">main =</span> <span class="st">"Multipolygons"</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(bug_multiline), <span class="at">col =</span> <span class="fu">rainbow</span>(<span class="fu">nrow</span>(bug_multiline)), <span class="at">main =</span> <span class="st">"Multilines"</span>)</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(bug_multipts), <span class="at">col =</span> <span class="fu">rainbow</span>(<span class="fu">nrow</span>(bug_multipts)), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">main =</span> <span class="st">"Multipoints"</span>)</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(bug_poly), <span class="at">col =</span> <span class="fu">rainbow</span>(<span class="fu">nrow</span>(bug_poly)), <span class="at">main =</span> <span class="st">"Polygons"</span>)</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(bug_line), <span class="at">col =</span> <span class="fu">rainbow</span>(<span class="fu">nrow</span>(bug_line)), <span class="at">main =</span> <span class="st">"Lines"</span>)</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(bug_pts), <span class="at">col =</span> <span class="fu">rainbow</span>(<span class="fu">nrow</span>(bug_pts)), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">main =</span> <span class="st">"Points"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="points-to-lines" class="level3" data-number="5.5.3">
<h3 data-number="5.5.3" class="anchored" data-anchor-id="points-to-lines"><span class="header-section-number">5.5.3</span> Points to lines</h3>
<p>It is of course not possible to convert points directly to polygons, but if you have an <code>sf</code> object with points in the right order, you can easily build a linestring. As an example, let’s extract the first 10 vertices of the Sempach multipolygon. Once you have an <code>sf</code> object with ordered points, you need to group them into a single multipoints geometry using the <code>st_combine()</code> function, and then call the <code>st_cast()</code> function on this new object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>sempach_pts <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(muni[muni<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Sempach"</span>,], <span class="at">to =</span> <span class="st">"POINT"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,]</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>sempach_multipts <span class="ot">&lt;-</span> <span class="fu">st_combine</span>(sempach_pts)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>sempach_line <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(sempach_multipts, <span class="st">"LINESTRING"</span>)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(sempach_pts), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">main =</span> <span class="st">"Points"</span>)</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(sempach_pts, <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(sempach_pts), <span class="at">pos =</span> <span class="dv">4</span>, <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sempach_line, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">main =</span> <span class="st">"Linestring"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="lines-to-polygons" class="level3" data-number="5.5.4">
<h3 data-number="5.5.4" class="anchored" data-anchor-id="lines-to-polygons"><span class="header-section-number">5.5.4</span> Lines to polygons</h3>
<p>If you have a linestring or multilinestring geometry forming a closed ring, you can easily convert it to a polygon. As an example, let’s use the outer ring of the Sempach multipolygon.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>sempach_multiline <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(muni[muni<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Sempach"</span>,], <span class="at">to =</span> <span class="st">"MULTILINESTRING"</span>)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>sempach_poly <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(sempach_multiline, <span class="at">to =</span> <span class="st">"POLYGON"</span>)</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(sempach_multiline), <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">main =</span> <span class="st">"Multilinestring"</span>)</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(sempach_poly), <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">main =</span> <span class="st">"Polygon"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Exercise (5 minutes)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise (5 minutes)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Create a new object containing only the polygon for Sursee, check its validity and compute its perimeter using the <code>st_length()</code> function, compare with the result of the <code>st_perimeter()</code> function.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>sursee_poly <span class="ot">&lt;-</span> muni[muni<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Sursee"</span>,]</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>sursee_multiline <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(sursee_poly, <span class="at">to =</span> <span class="st">"MULTILINESTRING"</span>)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="fu">st_length</span>(sursee_multiline)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="fu">st_perimeter</span>(sursee_poly)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</section>
</section>
<section id="spatial-predicates" class="level2" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="spatial-predicates"><span class="header-section-number">5.6</span> Spatial predicates</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-11-contents" aria-controls="callout-11" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-11" class="callout-11-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>muni <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"municipalities"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>streets <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"streets"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/observations.csv"</span>)</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(obs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Topology describes the spatial relationships between vector objects. For example, two features can intersect, or one feature can contain another one. The existence of such relationships between features is tested by functions called spatial (binary) predicates. Many are available in the <code>sf</code> package, use <code>?geos_binary_pred</code> if you want to see the full list.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>When using spatial predicates you must be sure that both objects use the same CRS.</p>
</div>
</div>
<p>We can for example easily test whether bird sightings are located in Sempach, or somewhere else.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>sempach <span class="ot">&lt;-</span> muni[muni<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Sempach"</span>,]</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>obs_in_sempach <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(obs, sempach)</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>obs_in_sempach</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 530, where the
predicate was `intersects'
first 10 elements:
 1: 1
 2: 1
 3: 1
 4: 1
 5: 1
 6: 1
 7: 1
 8: 1
 9: 1
 10: 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lengths</span>(obs_in_sempach) <span class="sc">&gt;</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Mode   FALSE    TRUE 
logical     222     308 </code></pre>
</div>
</div>
<p>The output is stored in an memory efficient sparse matrix format which is not always easily readable by humans. We can use the <code>sparse = FALSE</code> argument to get a non-sparse matrix and perform standard operations (e.g.&nbsp;computing the number of sightings in Sempach).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>obs_in_sempach <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(obs, sempach, <span class="at">sparse =</span> <span class="cn">FALSE</span>)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(obs_in_sempach)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        [,1]
[525,] FALSE
[526,] FALSE
[527,]  TRUE
[528,] FALSE
[529,]  TRUE
[530,] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(obs_in_sempach)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 308</code></pre>
</div>
</div>
<p>Using another predicate (<code>st_disjoint</code>), we can get a list of all sightings that are in other municipalities. Of course, this computation is superfluous in this case since the output of the <code>st_disjoint()</code> function is the complement of the set provided by the <code>st_intersects()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>obs_not_in_sempach <span class="ot">&lt;-</span> <span class="fu">st_disjoint</span>(obs, sempach, <span class="at">sparse =</span> <span class="cn">FALSE</span>)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(obs_not_in_sempach)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 222</code></pre>
</div>
</div>
<p>We can easily find all the sightings that are located within 1km of the Swiss Ornithological Institute.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>soi <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(<span class="st">"POINT(2657271 1219754)"</span>, <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_is_within_distance</span>(soi, obs, <span class="at">dist =</span> <span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 1, where the predicate
was `is_within_distance'
 1: 62, 63, 89, 90, 92, 113, 114, 123, 135, 136, ...</code></pre>
</div>
</div>
<p>Things get a bit more complex when the two elements used inside the predicate contain multiple features. In this example we test for intersections between two municipalities and all the highway segments stored in the streets data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>muni_extract <span class="ot">&lt;-</span> muni[<span class="dv">6</span><span class="sc">:</span><span class="dv">7</span>,]</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>highways <span class="ot">&lt;-</span> streets[streets<span class="sc">$</span>type <span class="sc">==</span> <span class="dv">2</span>,]</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="fu">st_intersects</span>(muni_extract, highways)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 2, where the predicate
was `intersects'
 1: 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, ...
 2: 1, 2, 3, 4, 5, 19, 20, 58</code></pre>
</div>
</div>
<p>Don’t hesitate to try other predicates (e.g.&nbsp;<code>st_within()</code>, <code>st_contains()</code>). The difference between some of them is sometimes quite subtle (e.g., the influence of the feature border). If you need even more flexibility you should use the <code>st_relate()</code> function. This flexibility comes with a price, though. The <code>st_relate()</code> function is much slower since it doesn’t use spatial indices. If you want an in-depth explanation of all the possibilities, you should check the following website: <a href="https://en.wikipedia.org/wiki/DE-9IM" target="_blank">https://en.wikipedia.org/wiki/DE-9IM</a>.</p>
</section>
<section id="spatial-subsetting" class="level2" data-number="5.7">
<h2 data-number="5.7" class="anchored" data-anchor-id="spatial-subsetting"><span class="header-section-number">5.7</span> Spatial subsetting</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-13-contents" aria-controls="callout-13" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-13" class="callout-13-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>muni <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"municipalities"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/observations.csv"</span>)</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(obs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>sempach <span class="ot">&lt;-</span> muni[muni<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Sempach"</span>,]</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>soi <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(<span class="st">"POINT(2657271 1219754)"</span>, <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Now that we know how to test different topological properties, we can use them to subset data spatially. The <code>sf</code> package allows doing that using the usual <code>[]</code> notation. The <code>st_intersects</code> predicate is used by default if you don’t specify anything. This is how we create a new <code>sf</code> object containing only the sightings in Sempach.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>obs_in_sempach <span class="ot">&lt;-</span> obs[sempach,]</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Equivalent to</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>obs_in_sempach <span class="ot">&lt;-</span> obs[sempach, , op <span class="ot">=</span> st_intersects]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The empty argument can be used to specify the desired attribute columns.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Exercise (5 minutes)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise (5 minutes)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Within a 2 km radius around Swiss Ornithological Institute, how many bird sightings are in Neuenkirch? Try to make a map of the municipalities with the filtered sightings.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>neuenkirch <span class="ot">&lt;-</span> muni[muni<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Neuenkirch"</span>,]</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>obs_within_2000m <span class="ot">&lt;-</span> obs[soi, , op <span class="ot">=</span> st_is_within_distance, dist <span class="ot">=</span> <span class="dv">2000</span>]</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>obs_filtered <span class="ot">&lt;-</span> obs_within_2000m[neuenkirch,]</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(obs_filtered)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(muni))</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(obs_filtered), <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</section>
<section id="spatial-joins" class="level2" data-number="5.8">
<h2 data-number="5.8" class="anchored" data-anchor-id="spatial-joins"><span class="header-section-number">5.8</span> Spatial joins</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>muni <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"municipalities"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/observations.csv"</span>)</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(obs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>We’ve already seen how to join a spatial object to another table using attributes. Now we’ll do something similar but instead of using attributes, we’ll perform a join between spatial objects based on their topological relationships. As a first example we will join the bird sightings data set with the municipalities data set. As output we will get the bird sightings with additional attributes corresponding to their respective municipality. We’ll do this using the <code>st_join()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>obs_muni <span class="ot">&lt;-</span> <span class="fu">st_join</span>(obs, muni, <span class="at">join =</span> st_intersects)</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>obs_muni</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 530 features and 6 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 2649549 ymin: 1218571 xmax: 2660110 ymax: 1225531
Projected CRS: CH1903+ / LV95
First 10 features:
   species_id             name.x       date  bfs  name.y popsize
1        4240 Eurasian Blackbird 2022-04-12 1102 Sempach    4186
2        3800  Eurasian Blue Tit 2022-04-12 1102 Sempach    4186
3        4240 Eurasian Blackbird 2022-05-09 1102 Sempach    4186
4        4240 Eurasian Blackbird 2022-05-09 1102 Sempach    4186
5        4240 Eurasian Blackbird 2022-05-09 1102 Sempach    4186
6        3800  Eurasian Blue Tit 2022-05-09 1102 Sempach    4186
7        4240 Eurasian Blackbird 2022-05-09 1102 Sempach    4186
8        3800  Eurasian Blue Tit 2022-05-09 1102 Sempach    4186
9        4240 Eurasian Blackbird 2022-05-23 1102 Sempach    4186
10       4240 Eurasian Blackbird 2022-05-23 1102 Sempach    4186
                  geometry
1  POINT (2658433 1220946)
2  POINT (2658442 1221138)
3  POINT (2658607 1221189)
4  POINT (2658597 1221137)
5  POINT (2658569 1220956)
6  POINT (2658476 1220904)
7  POINT (2658514 1221205)
8  POINT (2658517 1221195)
9  POINT (2658570 1221219)
10 POINT (2658455 1220911)</code></pre>
</div>
</div>
<p>In this example both data sets have an attributed called “name”. When we join them together, R is automatically renaming these columns to “name.x” and “name.y”. The “x” and “y” corresponds to the order of the data sets when calling the <code>st_join()</code> function. We can now easily compute the number of sightings per municipality.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(obs_muni<span class="sc">$</span>name.y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
      Eich Neuenkirch    Nottwil  Oberkirch   Schenkon    Sempach     Sursee 
         7         52         10         86         11        308         56 </code></pre>
</div>
</div>
<p>Let’s try another spatial join, this time we will join the sightings with a landcover data set, which is an extract of the <a href="https://www.swisstopo.admin.ch/en/landscape-model-swisstlm3d" target="_blank">swissTLM3D</a> data set provided by Swisstopo. The goal of the analysis it to add a new attribute to the bird sightings data set corresponding to the landcover value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>landcover <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"landcover"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>obs_landcover <span class="ot">&lt;-</span> <span class="fu">st_join</span>(obs, landcover, <span class="at">join =</span> st_intersects)</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>obs_landcover</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 548 features and 5 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 2649549 ymin: 1218571 xmax: 2660110 ymax: 1225531
Projected CRS: CH1903+ / LV95
First 10 features:
   species_id               name       date type year                geometry
1        4240 Eurasian Blackbird 2022-04-12   NA   NA POINT (2658433 1220946)
2        3800  Eurasian Blue Tit 2022-04-12   14 2013 POINT (2658442 1221138)
3        4240 Eurasian Blackbird 2022-05-09   12 2013 POINT (2658607 1221189)
4        4240 Eurasian Blackbird 2022-05-09   12 2013 POINT (2658597 1221137)
5        4240 Eurasian Blackbird 2022-05-09   12 2013 POINT (2658569 1220956)
6        3800  Eurasian Blue Tit 2022-05-09   10 2013 POINT (2658476 1220904)
7        4240 Eurasian Blackbird 2022-05-09   12 2013 POINT (2658514 1221205)
8        3800  Eurasian Blue Tit 2022-05-09   12 2013 POINT (2658517 1221195)
9        4240 Eurasian Blackbird 2022-05-23   12 2013 POINT (2658570 1221219)
10       4240 Eurasian Blackbird 2022-05-23   NA   NA POINT (2658455 1220911)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(obs_landcover<span class="sc">$</span>type, <span class="at">useNA =</span> <span class="st">"always"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   6   10   11   12   14 &lt;NA&gt; 
   4   19   55   55   54  361 </code></pre>
</div>
</div>
<p>By default the <code>st_join()</code> function will use <code>st_intersects</code> as a predicate, but you can of course specify a different one. Moreover it performs what is called a left join, which means the output will contain all rows from the first object (<code>obs</code> in our example). It is also possible to perform an inner join by adding the attribute <code>left = FALSE</code>. In this case the output will contain only the rows for which a value was found (i.e.&nbsp;where a spatial match occurred).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>obs_landcover_inner <span class="ot">&lt;-</span> <span class="fu">st_join</span>(obs, landcover, <span class="at">join =</span> st_intersects, <span class="at">left =</span> <span class="cn">FALSE</span>)</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>obs_landcover_inner</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 187 features and 5 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 2649549 ymin: 1218822 xmax: 2659732 ymax: 1225026
Projected CRS: CH1903+ / LV95
First 10 features:
     species_id               name       date type year                geometry
2          3800  Eurasian Blue Tit 2022-04-12   14 2013 POINT (2658442 1221138)
3          4240 Eurasian Blackbird 2022-05-09   12 2013 POINT (2658607 1221189)
4          4240 Eurasian Blackbird 2022-05-09   12 2013 POINT (2658597 1221137)
5          4240 Eurasian Blackbird 2022-05-09   12 2013 POINT (2658569 1220956)
6          3800  Eurasian Blue Tit 2022-05-09   10 2013 POINT (2658476 1220904)
7          4240 Eurasian Blackbird 2022-05-09   12 2013 POINT (2658514 1221205)
8          3800  Eurasian Blue Tit 2022-05-09   12 2013 POINT (2658517 1221195)
9          4240 Eurasian Blackbird 2022-05-23   12 2013 POINT (2658570 1221219)
11         4240 Eurasian Blackbird 2022-06-06   11 2013 POINT (2658530 1220902)
11.1       4240 Eurasian Blackbird 2022-06-06    6 2013 POINT (2658530 1220902)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(obs_landcover_inner<span class="sc">$</span>type, <span class="at">useNA =</span> <span class="st">"always"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   6   10   11   12   14 &lt;NA&gt; 
   4   19   55   55   54    0 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Exercise (5 minutes)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise (5 minutes)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Have a look at the number of features (rows) of the original <code>obs</code> data set and compare it with the number of features of the <code>obs_landcover</code> data set. Why are they different?</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(obs)</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(obs_landcover)</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="co"># This difference is caused by overlapping polygons in the landcover data set. If a bird sighting</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="co"># is inside 2 polygons, the st_join() function will create 2 rows (one row for each intersecting polygon).</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This means some sightings will be duplicated. We call this kind of joins "one-to-many".</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a><span class="co"># You can find these duplicated sightings by looking at the row names with the rownames() function, or by</span></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a><span class="co"># adding an unique ID to all the sightings before the spatial join and then looking for duplicated IDs.</span></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>dupl <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"."</span>, <span class="fu">rownames</span>(obs_landcover), <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>dupl <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">c</span>(dupl, dupl <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a>obs_landcover[dupl,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
<p>Since the landcover data is not a complete coverage of our study area, which leads to NA values in our joined data set, we can maybe try to get more complete results by using another spatial predicate. The <code>st_nearest_feature</code> predicate will join the sightings to the nearest landcover polygon. Polygons containing points will be considered to be the closest ones. I honestly don’t know what is happening when a point is within overlapping polygons. My first thoughts were that it would take the attributes from the highest or lowest polygon in the stack of overlapping polygons, but there’s no clear pattern.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>obs_landcover2 <span class="ot">&lt;-</span> <span class="fu">st_join</span>(obs, landcover, <span class="at">join =</span> st_nearest_feature)</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>obs_landcover2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 530 features and 5 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 2649549 ymin: 1218571 xmax: 2660110 ymax: 1225531
Projected CRS: CH1903+ / LV95
First 10 features:
   species_id               name       date type year                geometry
1        4240 Eurasian Blackbird 2022-04-12   11 2013 POINT (2658433 1220946)
2        3800  Eurasian Blue Tit 2022-04-12   14 2013 POINT (2658442 1221138)
3        4240 Eurasian Blackbird 2022-05-09   12 2013 POINT (2658607 1221189)
4        4240 Eurasian Blackbird 2022-05-09   12 2013 POINT (2658597 1221137)
5        4240 Eurasian Blackbird 2022-05-09   12 2013 POINT (2658569 1220956)
6        3800  Eurasian Blue Tit 2022-05-09   10 2013 POINT (2658476 1220904)
7        4240 Eurasian Blackbird 2022-05-09   12 2013 POINT (2658514 1221205)
8        3800  Eurasian Blue Tit 2022-05-09   12 2013 POINT (2658517 1221195)
9        4240 Eurasian Blackbird 2022-05-23   12 2013 POINT (2658570 1221219)
10       4240 Eurasian Blackbird 2022-05-23   10 2013 POINT (2658455 1220911)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(obs_landcover2<span class="sc">$</span>type, <span class="at">useNA =</span> <span class="st">"always"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   6   10   11   12   14 &lt;NA&gt; 
   8  144   61   60  257    0 </code></pre>
</div>
</div>
<p>In this example we joined a point data set to a polygon data set and this is the most common application for a spatial join. However we’re not restricted to these combinations, we can join all the vector types (e.g.&nbsp;polygons with polygons). If you’re joining polygons to polygons, <code>st_join()</code> is also able to perform joins based on the maximum area overlay (it joins with the polygon having the largest overlap). To do this, you need to add the <code>largest = TRUE</code> argument.</p>
</section>
<section id="distance-operations" class="level2" data-number="5.9">
<h2 data-number="5.9" class="anchored" data-anchor-id="distance-operations"><span class="header-section-number">5.9</span> Distance operations</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>muni <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"municipalities"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/observations.csv"</span>)</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(obs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>soi <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(<span class="st">"POINT(2657271 1219754)"</span>, <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Calculating distances between <code>sf</code> objects is done with the <code>st_distance()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_distance</span>(obs[<span class="dv">1</span>,], soi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m]
         [,1]
[1,] 1664.665</code></pre>
</div>
</div>
<p>Once again, we see that <code>sf</code> is using units. We also note that the results are stored in a matrix instead of a vector. This format is actually needed since <code>st_distance()</code> can also be used to compute all the distance combinations between two <code>sf</code> objects containing multiple features.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_distance</span>(obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,], muni[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m]
         [,1]     [,2] [,3]
[1,] 438.6257 2585.144    0
[2,] 424.5501 2675.472    0
[3,] 254.1488 2845.707    0
[4,] 286.7366 2813.814    0
[5,] 302.5583 2714.238    0</code></pre>
</div>
</div>
<p>The distances are measured between the points and the nearest edge of the polygons if they are located outside the polygons. The distance will be 0 if they are within the polygon.</p>
<p>We will now make a short excursion in the world of geographic CRS with a quick example showing what <code>sf</code> is doing when we don’t use standard Euclidean geometry. We will compute the distance between the centroids of Switzerland and Australia. By default <code>sf</code> is using the <code>s2</code> library to perform its computations on a spheroid when we use a geographic CRS. However for distances, it is possible to obtain better approximations by using an ellipsoid. To do this, we need to tell <code>sf</code> to avoid using <code>s2</code> with the function <code>sf_use_s2(FALSE)</code>. The <code>st_distance()</code> will thus be forced to use a more precise algorithm (by automatically using a similar function from the <code>lwgeom</code> package). We can of course compare the two estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>world_centroids <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(World)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: st_centroid assumes attributes are constant over geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>pt1 <span class="ot">&lt;-</span> world_centroids[world_centroids<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Switzerland"</span>,]</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>pt2 <span class="ot">&lt;-</span> world_centroids[world_centroids<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Australia"</span>,]</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_use_s2</span>(<span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Spherical geometry (s2) switched off</code></pre>
</div>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>(d1 <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(pt1, pt2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m]
         [,1]
[1,] 14776830</code></pre>
</div>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_use_s2</span>(<span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Spherical geometry (s2) switched on</code></pre>
</div>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>(d2 <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(pt1, pt2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m]
         [,1]
[1,] 14779871</code></pre>
</div>
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">abs</span>(d2 <span class="sc">-</span> d1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m]
         [,1]
[1,] 3040.018</code></pre>
</div>
</div>
<p>The distance we’re measuring is shown on the following map. Since the earth is not flat, the shortest distance between two points is not a straight line. These shortest distance lines are called great circles.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>gcLine <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(<span class="fu">st_combine</span>(<span class="fu">rbind</span>(pt1, pt2)), <span class="st">"LINESTRING"</span>)</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>gcLine <span class="ot">&lt;-</span> <span class="fu">st_segmentize</span>(gcLine, <span class="dv">1000</span>)</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>extent <span class="ot">&lt;-</span> World[World<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Iceland"</span> <span class="sc">|</span> World<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Norway"</span> <span class="sc">|</span> World<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Australia"</span>,]</span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(World), <span class="at">extent =</span> extent, <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gcLine, <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(pt1), <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(pt2), <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>All the <code>sf</code> objects plotted on this map have the same geographic CRS but a map is a plane… To plot this kind of data, <code>sf</code> thus needs to perform some projection. Almost all GIS software (including <code>sf</code>) use a simple projection called plate carrée which maps <em>x</em> to be the value of the longitude and <em>y</em> to be the value of the latitude. This is not a good projection if you want to publish a world map. The distortions can get quite large (e.g., Switzerland will be too elongated). We will see better alternatives later in this tutorial.</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>We’ve already seen examples where turning <code>s2</code> off will provide more precise results when using a geographic CRS. But keep in mind that computing areas, lengths or distances are probably the only valid cases where turning <code>s2</code> off is a good idea. For all other computations based on geographic CRSs you should NOT deactivate <code>s2</code>, otherwise you’ll get results that will most probably be wrong.</p>
</div>
</div>
</section>
<section id="buffers" class="level2" data-number="5.10">
<h2 data-number="5.10" class="anchored" data-anchor-id="buffers"><span class="header-section-number">5.10</span> Buffers</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-20-contents" aria-controls="callout-20" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-20" class="callout-20-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>muni <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"municipalities"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/observations.csv"</span>)</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(obs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Buffering objects is one of the most common operations in GIS. A buffer is a polygon showing the area within a given distance of a spatial object. You can buffer all the existing vector types with the <code>st_buffer()</code> function. For the distance, you can either specify a numeric value, or an object of class <code>units</code>. If you use a numeric value, the unit will the one of the used CRS (i.e., meters for the Swiss CRS we’re using). You can also specify a vector of distances (one distance for each feature).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>obs_buff <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(obs[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>),], <span class="at">dist =</span> <span class="dv">80</span>)</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>obs_buff_var <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(obs[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>),], <span class="at">dist =</span> <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">80</span>, <span class="dv">100</span>))</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(obs_buff), <span class="at">col =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">main =</span> <span class="st">"Fixed width"</span>)</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(obs_buff_var), <span class="at">col =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">main =</span> <span class="st">"Variable width"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In the GIS world curves are often approximated using small segments, even though curves exists in the Simple Feature standard (but they’re often poorly implemented in GIS software). The number of segments used to create the buffers is controlled by the argument <code>nQuadSegs</code> (= number of segments per quadrant). You can change this value to create buffers with octagonal shapes. You can also increase the default value if you need better precision.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>obs_buff_oct <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(obs[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>),], <span class="at">dist =</span> <span class="dv">80</span>, <span class="at">nQuadSegs =</span> <span class="dv">2</span>)</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(obs_buff_oct), <span class="at">col =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Each feature will get its own buffer, which means that, if they’re close enough and/or the distance is large enough, the buffers will overlap but they’re still separate features. It is possible to merge overlapping buffers using the <code>st_union()</code> function. The function will produce a single multipolygon, that’s why we need to transform the output into a polygon to recover the non-overlapping buffers as separate features. Note that you will lose the attributes of the original features with this operation. If you need to recover some of them, you can use a spatial join (but be careful: what do you really want for the merged buffers?).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>obs_buff_merged <span class="ot">&lt;-</span> <span class="fu">st_union</span>(obs_buff)</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>obs_buff_merged <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(obs_buff_merged, <span class="st">"POLYGON"</span>)</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(obs_buff_merged, <span class="at">col =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When using polygons, we can also specify negative distances to create “inside” buffers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>muni_buff <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(muni, <span class="at">dist =</span> <span class="sc">-</span><span class="dv">500</span>)</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(muni))</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(muni_buff), <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When buffering lines or polygons, we have three different options to control what will happen at corners: <code>ROUND</code>, <code>BEVEL</code> and <code>MITRE</code>. The default is to use rounded corners but we can easily change that with the <code>joinStyle</code> argument. When using the MITRE style, we can control the maximum distance from the original geometry with the <code>mitreLimit</code> argument. This is expressed as a ratio of the buffer distance and the default value is 1 (e.g., a value of 2 means that we allow distances up to twice the chosen buffer distance for corners).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>pol <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(<span class="st">"POLYGON((2656000 1221000, 2657000 1221000, 2657000 1220000, 2658000 1220000, 2658000 1219000, 2656000 1219000, 2656000 1221000))"</span>, <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>pol_buff1 <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(pol, <span class="dv">400</span>, <span class="at">joinStyle =</span> <span class="st">"ROUND"</span>)</span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>pol_buff2 <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(pol, <span class="dv">400</span>, <span class="at">joinStyle =</span> <span class="st">"BEVEL"</span>)</span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>pol_buff3 <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(pol, <span class="dv">400</span>, <span class="at">joinStyle =</span> <span class="st">"MITRE"</span>)</span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>pol_buff4 <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(pol, <span class="dv">400</span>, <span class="at">joinStyle =</span> <span class="st">"MITRE"</span>, <span class="at">mitreLimit =</span> <span class="dv">2</span>)</span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol_buff1, <span class="at">main =</span> <span class="st">"joinStyle = ROUND"</span>)</span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol, <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol_buff2, <span class="at">main =</span> <span class="st">"joinStyle = BEVEL"</span>)</span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol, <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol_buff3, <span class="at">main =</span> <span class="st">"joinStyle = MITRE (limit=1)"</span>)</span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol, <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol_buff4, <span class="at">main =</span> <span class="st">"joinStyle = MITRE (limit=2)"</span>)</span>
<span id="cb162-16"><a href="#cb162-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol, <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Similarly when buffering lines that don’t form a closed ring, we also have three options to control how line endings are handled: <code>ROUND</code>, <code>FLAT</code> and <code>SQUARE</code>. The default is to use rounded line endings but we can easily change that with the <code>endCapStyle</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>line <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(<span class="st">"LINESTRING(2656000 1220000, 2657000 1221000, 2658000 1220000)"</span>, <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>line_buff1 <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(line, <span class="dv">400</span>, <span class="at">endCapStyle =</span> <span class="st">"ROUND"</span>)</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>line_buff2 <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(line, <span class="dv">400</span>, <span class="at">endCapStyle =</span> <span class="st">"FLAT"</span>)</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>line_buff3 <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(line, <span class="dv">400</span>, <span class="at">endCapStyle =</span> <span class="st">"SQUARE"</span>)</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">1</span>))</span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(line_buff1, <span class="at">main =</span> <span class="st">"endCapStyle = ROUND"</span>)</span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(line, <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(line_buff2, <span class="at">main =</span> <span class="st">"endCapStyle = FLAT"</span>)</span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(line, <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb163-12"><a href="#cb163-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(line_buff3, <span class="at">main =</span> <span class="st">"endCapStyle = SQUARE"</span>)</span>
<span id="cb163-13"><a href="#cb163-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(line, <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>One last interesting possibility with lines consists of buffering only one side of the line features. We can do that by setting the <code>singleSide</code> argument to <code>TRUE</code>. Positive distance values will buffer the left-hand side (considering the line direction) of the line feature, while negative values will buffer the right-hand side.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>line_singlebuff1 <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(line, <span class="dv">400</span>, <span class="at">singleSide =</span> <span class="cn">TRUE</span>)</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>line_singlebuff2 <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(line, <span class="sc">-</span><span class="dv">400</span>, <span class="at">singleSide =</span> <span class="cn">TRUE</span>)</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">1</span>))</span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(line_singlebuff1)</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(line, <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(line_singlebuff2)</span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(line, <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you use a geographic CRS and <code>sf_use_s2()</code> is <code>TRUE</code>, a numeric value for the distance will be taken as a distance in meters. If <code>sf_use_s2()</code> is <code>FALSE</code>, the unit will be degrees and the output probably won’t make any sense.</p>
</div>
</div>
</section>
<section id="affine-transformations" class="level2" data-number="5.11">
<h2 data-number="5.11" class="anchored" data-anchor-id="affine-transformations"><span class="header-section-number">5.11</span> Affine transformations</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>muni <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"municipalities"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>sempach <span class="ot">&lt;-</span> muni[muni<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Sempach"</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p><code>sf</code> provide methods to transform <code>sfc</code> and <code>sfg</code> objects, this is however not possible with <code>sf</code> objects (but have a look at the trick at the end of this section). Shifting a geometry is the easiest operation. The next example will shift the borders of Sempach, 500 meters to the north and 200 meters to the east. The shift is always done using the unit defined in the CRS used by the spatial object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>sempach_sfc <span class="ot">&lt;-</span> <span class="fu">st_geometry</span>(sempach)</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>sempach_sfc_shift <span class="ot">&lt;-</span> sempach_sfc <span class="sc">+</span> <span class="fu">c</span>(<span class="dv">500</span>, <span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The output of an affine transformation will unfortunately lose its CRS information (it will be NA). This is a problem, especially if you plan to do further analyses or make maps with the transformed data. You can use the <code>st_crs()</code> function to reassign it based on the original data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(sempach_sfc_shift) <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(sempach_sfc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>We can also scale the geometries, but we need a reference point (such as the centroid) for each feature. Once we have these reference points, we can center the geometries by shifting them, apply the scaling, and shift them back to their original locations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>muni_sfc <span class="ot">&lt;-</span> <span class="fu">st_geometry</span>(muni)</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>muni_sfc_centroids <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(muni_sfc)</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>muni_sfc_scale <span class="ot">&lt;-</span> (muni_sfc <span class="sc">-</span> muni_sfc_centroids) <span class="sc">*</span> <span class="fl">0.5</span> <span class="sc">+</span> muni_sfc_centroids</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muni_sfc, <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muni_sfc_scale, <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-68-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Rotation is another common affine transformation. We also need to define a reference point for each feature and perform the same shifting operations. However, instead of multiplying with a scalar we now use a rotation matrix. Remember that a 2D vector (i.e.&nbsp;coordinates) will be rotated by an angle <span class="math inline">\(\theta\)</span> when we multiply it with the following matrix:</p>
<p><span class="math display">\[R=
\begin{pmatrix}
\cos(\theta) &amp; -\sin(\theta)\\
\sin(\theta) &amp; \cos(\theta)
\end{pmatrix}
\]</span></p>
<p>We can of course combine different transformations, such as scaling and rotation…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>rotation <span class="ot">&lt;-</span> <span class="cf">function</span>(theta){</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>  theta_rad <span class="ot">&lt;-</span> theta <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">180</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fu">cos</span>(theta_rad), <span class="fu">sin</span>(theta_rad), <span class="sc">-</span><span class="fu">sin</span>(theta_rad), <span class="fu">cos</span>(theta_rad)), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>muni_sfc_rotate <span class="ot">&lt;-</span> (muni_sfc <span class="sc">-</span> muni_sfc_centroids) <span class="sc">*</span> <span class="fu">rotation</span>(<span class="dv">30</span>) <span class="sc">+</span> muni_sfc_centroids</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>muni_sfc_scale_rotate <span class="ot">&lt;-</span> (muni_sfc <span class="sc">-</span> muni_sfc_centroids) <span class="sc">*</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">rotation</span>(<span class="dv">30</span>) <span class="sc">+</span> muni_sfc_centroids</span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muni_sfc, <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muni_sfc_rotate, <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muni_sfc, <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muni_sfc_scale_rotate, <span class="at">col =</span> <span class="st">"navy"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Once all the transformations are performed, we can use the <code>st_set_geometry()</code> function to create a new <code>sf</code> object combining the new geometry with the attributes of the original <code>sf</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>muni2 <span class="ot">&lt;-</span> <span class="fu">st_set_geometry</span>(muni, muni_sfc_scale_rotate)</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(muni2) <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(muni)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="combine-geometries" class="level2" data-number="5.12">
<h2 data-number="5.12" class="anchored" data-anchor-id="combine-geometries"><span class="header-section-number">5.12</span> Combine geometries</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-24-contents" aria-controls="callout-24" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-24" class="callout-24-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>muni <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"municipalities"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>sempach <span class="ot">&lt;-</span> muni[muni<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Sempach"</span>,]</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>streets <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"streets"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/observations.csv"</span>)</span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(obs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Combining geometries from two different data sets is one of the most common analysis performed in a GIS. The four main operations are the following ones: union, intersection, difference and symmetric difference. The following figure shows a graphical overview of these operations with the function names (source: Lovelace <em>et al.</em>, 2019<span class="citation" data-cites="lovelace_geocomputation_2025"><sup><a href="references.html#ref-lovelace_geocomputation_2025" role="doc-biblioref">2</a></sup></span>):</p>
<p><img src="figures/venn-clip-1.png" class="img-fluid" style="width:70.0%"></p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>When you combine geometries from different data sets, you need to be sure that they all have the same CRS.</p>
</div>
</div>
<section id="merge-geometries" class="level3" data-number="5.12.1">
<h3 data-number="5.12.1" class="anchored" data-anchor-id="merge-geometries"><span class="header-section-number">5.12.1</span> Merge geometries</h3>
<p>As we’ve seen earlier, we can use the <code>st_union()</code> function with a single data set to merge its geometries. All polygons with common borders will be merged together. If you have line geometries, the function will merge all the lines that are touching or intersecting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>muni_merged <span class="ot">&lt;-</span> <span class="fu">st_union</span>(muni)</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>muni_merged</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Geometry set for 1 feature 
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 2648317 ymin: 1213352 xmax: 2660750 ymax: 1227618
Projected CRS: CH1903+ / LV95</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>POLYGON ((2659099 1221637, 2659104 1221610, 265...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muni_merged, <span class="at">col =</span> <span class="st">"navy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-72-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If you use the <code>st_union()</code> function on a polygon data set where some geometries don’t have common borders, you’ll get a single multipolygon geometry as output. You can easily disaggregate the parts using the <code>st_cast()</code> function. This operation is sometimes called “exploding” a multipart geometry.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>muni_merged <span class="ot">&lt;-</span> <span class="fu">st_union</span>(muni[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">6</span>, <span class="dv">7</span>),])</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>muni_merged</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Geometry set for 1 feature 
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 2648801 ymin: 1213352 xmax: 2660750 ymax: 1227618
Projected CRS: CH1903+ / LV95</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>MULTIPOLYGON (((2656850 1219147, 2656890 121912...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>muni_merged_exploded <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(muni_merged, <span class="st">"POLYGON"</span>)</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>muni_merged_exploded</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Geometry set for 2 features 
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 2648801 ymin: 1213352 xmax: 2660750 ymax: 1227618
Projected CRS: CH1903+ / LV95</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>POLYGON ((2656850 1219147, 2656890 1219126, 265...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>POLYGON ((2648835 1225721, 2648864 1225750, 264...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muni_merged_exploded, <span class="at">col =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-73-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The <code>st_union()</code> function can also be used to merge geometries between two <code>sf</code> objects having the same vector type.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>temp_poly <span class="ot">&lt;-</span> <span class="fu">st_geometry</span>(<span class="fu">st_buffer</span>(obs[<span class="dv">1</span>,], <span class="dv">2000</span>))</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_union</span>(temp_poly, sempach))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-74-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Exercise (5 minutes)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise (5 minutes)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Create an <code>sf</code> object with several points, include some points with the exact same location (but different attributes). Run the <code>st_union()</code> function on this new object and “explode” it to get the individual points. What happened?</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>pts <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(<span class="fu">c</span>(<span class="st">"POINT(2657000 1219000)"</span>, <span class="st">"POINT(2658000 1218000)"</span>, <span class="st">"POINT(2659000 1217000)"</span>, <span class="st">"POINT(2659000 1217000)"</span>), <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>pts_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">species =</span> <span class="fu">c</span>(<span class="st">"wallcreeper"</span>, <span class="st">"alpine chough"</span>, <span class="st">"kingfisher"</span>, <span class="st">"wallcreeper"</span>))</span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>pts_sf <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(pts_data, <span class="at">geometry =</span> pts)</span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a><span class="fu">st_cast</span>(<span class="fu">st_union</span>(pts_sf), <span class="st">"POINT"</span>)</span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The points with identical location were merged (even though the other attribute was different)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</section>
<section id="intersect-geometries" class="level3" data-number="5.12.2">
<h3 data-number="5.12.2" class="anchored" data-anchor-id="intersect-geometries"><span class="header-section-number">5.12.2</span> Intersect geometries</h3>
<p>Computing the intersection of geometries is another common GIS operation. For example, let’s calculate the intersection between the new polygon we’ve just created and the municipality of Sempach.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>muni_inter <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(sempach, temp_poly)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>muni_inter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 1 feature and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 2656433 ymin: 1219021 xmax: 2659072 ymax: 1222900
Projected CRS: CH1903+ / LV95
   bfs    name popsize                           geom
3 1102 Sempach    4186 POLYGON ((2657979 1222854, ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(muni_inter))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-76-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The returned object has the same class as that of the first argument. If you intersect two <code>sf</code> objects, the attributes of both objects will also be returned.</p>
<p>In a perfect world you’ll get polygons as output when you combine polygon (or multipolygon) objects with one of these functions. However, you may also get something more exotic. Let’s have a look at the following example which comes from one of the <code>sf</code> vignettes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">st_polygon</span>(<span class="fu">list</span>(<span class="fu">cbind</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">7.5</span>, <span class="fl">7.5</span>, <span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>))))</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">st_polygon</span>(<span class="fu">list</span>(<span class="fu">cbind</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">7</span>, <span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">1</span>))))</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>(inter <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(a, b))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GEOMETRYCOLLECTION (POLYGON ((7 0, 7 -0.5, 6 -0.5, 5.5 0, 7 0)), LINESTRING (4 0, 3 0), POINT (1 0))</code></pre>
</div>
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">1</span>))</span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(a, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"Intersecting two polygons:"</span>)</span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(b, <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">border =</span> <span class="st">"red"</span>)</span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(a, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"GEOMETRYCOLLECTION"</span>)</span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(b, <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">border =</span> <span class="st">"red"</span>)</span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(inter, <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">col =</span> <span class="st">"green"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-77-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Geometry collections are defined in the Simple Feature standard as a collection of different vector types. For example, one feature (row) could contain 2 polygons, 1 multiline and 3 points. The output of the previous intersection is clearly a geometry collection since the <code>st_intersection()</code> function produced 1 polygon, 1 line and 1 point. When performing an intersection or a similar operation, it is important to check that all the produced features have the expected geometry type. An geometry collection output is maybe not so common, but you may get a combination of polygons and multipolygons. Use the <code>st_geometry_type()</code> function (maybe in combination with <code>unique()</code>) to inspect the types.</p>
<p>Ideally we would use geometry collections directly in our analyses but you’ll quickly notice that most functions don’t work with them (and most GIS software don’t really know what to do with them either). Therefore you’ll need to decide which part of the collection is important for you. If you intersect polygons with polygons, most of the time you’ll be interested in the polygons and multipolygons outputs. You can use the <code>st_collection_extract()</code> function to perform this task.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_collection_extract</span>(inter, <span class="at">type =</span> <span class="st">"POLYGON"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>POLYGON ((7 0, 7 -0.5, 6 -0.5, 5.5 0, 7 0))</code></pre>
</div>
</div>
<p>This function will also return multipolygons (if they exist), even though we specified <code>type = "POLYGON"</code>. More generally, if some parts of the geometry collection are MULTI*, then all of the parts in the output will be MULTI*.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Exercise (5 minutes)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise (5 minutes)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Create a line object that is intersecting the streets data set. Compute the intersection using the <code>st_intersection()</code> function.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>temp_line <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(<span class="st">"LINESTRING(2657290 1219789, 2657090 1219789, 2657290 1219889)"</span>, <span class="at">crs =</span> <span class="dv">2056</span>)</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>temp_inter <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(temp_line, streets)</span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a><span class="fu">st_geometry_type</span>(temp_inter)</span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(temp_line, <span class="at">col =</span> <span class="st">"navy"</span>)</span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(streets), <span class="at">col =</span> <span class="st">"purple"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(temp_inter[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>], <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(temp_inter[<span class="dv">4</span>], <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a><span class="co"># We get a multipoint because our line intersected the same line twice</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</section>
<section id="erase-geometries" class="level3" data-number="5.12.3">
<h3 data-number="5.12.3" class="anchored" data-anchor-id="erase-geometries"><span class="header-section-number">5.12.3</span> Erase geometries</h3>
<p>The <code>st_difference()</code> function allows you to erase some parts of a geometry using another geometry (the intersection will be removed from the first one). As an example, let’s create a hole in the Sempach municipality using another polygon:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>temp_poly <span class="ot">&lt;-</span> <span class="fu">st_geometry</span>(<span class="fu">st_buffer</span>(obs[<span class="dv">1</span>,], <span class="dv">200</span>))</span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>sempach_hole <span class="ot">&lt;-</span> <span class="fu">st_difference</span>(sempach, temp_poly)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(sempach_hole), <span class="at">col =</span> <span class="st">"navy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-80-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The results of this function can get extremely confusing if there are multiple overlaps since <code>st_difference()</code> (and <code>st_sym_difference()</code>) will perform the difference operation on each pair of features (note that this isn’t a problem with the <code>st_intersection()</code> function). Let’s have a look at the following example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>obj1 <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(<span class="fu">c</span>(<span class="st">"POLYGON((-180 -20, -140 55, -50 0, -140 -60, -180 -20))"</span>, <span class="st">"POLYGON((-10 0, 140 60, 160 0, 140 -55, -10 0))"</span>))</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>obj2 <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(<span class="st">"POLYGON((-125 0, 0 60, 40 5, 15 -45, -125 0))"</span>)</span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(obj1, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.4</span>))</span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(obj2, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.4</span>), <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-81-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Our goal now is to remove the intersecting areas of the two <code>sfc</code> objects from the second object (in green). Most people would expect the following code to perform the appropriate task.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>diff1 <span class="ot">&lt;-</span> <span class="fu">st_difference</span>(obj2, obj1)</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>diff1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Geometry set for 2 features 
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -125 ymin: -45 xmax: 40 ymax: 60
CRS:           NA</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>POLYGON ((0 60, 40 5, 15 -45, -74.39759 -16.265...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>POLYGON ((0 60, 31.5493 16.61972, -10 0, 30.140...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(diff1[<span class="dv">1</span>,], <span class="at">col =</span> <span class="st">"navy"</span>)</span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(diff1[<span class="dv">2</span>,], <span class="at">col =</span> <span class="st">"navy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-82-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>However, because the <code>st_difference()</code> function is working on each pair of features, we get something that might look a bit strange. The function first computed the difference between <code>obj2</code> and the first feature of <code>obj1</code>, and then the difference between <code>obj2</code> and the second feature of <code>obj1</code>. We thus get two features instead of a single one where all intersecting areas were removed. If you have large data sets with a lot of overlaps, the number of output features will explode. To achieve what we want, we first need to group the features in <code>obj1</code> in a single feature using the <code>st_combine()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>diff2 <span class="ot">&lt;-</span> <span class="fu">st_difference</span>(obj2, <span class="fu">st_combine</span>(obj1))</span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>diff2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Geometry set for 1 feature 
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -82.99389 ymin: -45 xmax: 31.5493 ymax: 60
CRS:           NA</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>POLYGON ((0 60, 31.5493 16.61972, -10 0, 30.140...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(diff2, <span class="at">col =</span> <span class="st">"navy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-83-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Depending on the data you’re using, you’ll sometimes get an error warning using this trick (due to some invalid geometries generated in the background). If this happens you can try replacing the <code>st_combine()</code> function with <code>st_union()</code> or even combine the two (i.e., <code>st_union(st_combine(x))</code>).</p>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Exercise (5 minutes)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise (5 minutes)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here’s another output of the <code>st_difference()</code> function. Try to understand what is happening.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>obj3 <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(<span class="fu">c</span>(<span class="st">"POLYGON((-150 0, -100 10, -60 -5, -150 0))"</span>, <span class="st">"POLYGON((50 0, 120 40, 100 0, 120 -20, 50 0))"</span>))</span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(obj1, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.4</span>))</span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(obj3, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.4</span>), <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-6"><a href="#cb210-6" aria-hidden="true" tabindex="-1"></a>diff1 <span class="ot">&lt;-</span> <span class="fu">st_difference</span>(obj1, obj3)</span>
<span id="cb210-7"><a href="#cb210-7" aria-hidden="true" tabindex="-1"></a>diff2 <span class="ot">&lt;-</span> <span class="fu">st_difference</span>(obj1, <span class="fu">st_combine</span>(obj3))</span>
<span id="cb210-8"><a href="#cb210-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-9"><a href="#cb210-9" aria-hidden="true" tabindex="-1"></a>diff1</span>
<span id="cb210-10"><a href="#cb210-10" aria-hidden="true" tabindex="-1"></a>diff2</span>
<span id="cb210-11"><a href="#cb210-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-12"><a href="#cb210-12" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb210-13"><a href="#cb210-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(diff1[<span class="dv">1</span>,], <span class="at">col =</span> <span class="st">"navy"</span>)</span>
<span id="cb210-14"><a href="#cb210-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(diff1[<span class="dv">2</span>,], <span class="at">col =</span> <span class="st">"navy"</span>)</span>
<span id="cb210-15"><a href="#cb210-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(diff1[<span class="dv">3</span>,], <span class="at">col =</span> <span class="st">"navy"</span>)</span>
<span id="cb210-16"><a href="#cb210-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(diff1[<span class="dv">4</span>,], <span class="at">col =</span> <span class="st">"navy"</span>)</span>
<span id="cb210-17"><a href="#cb210-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-18"><a href="#cb210-18" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb210-19"><a href="#cb210-19" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(diff2[<span class="dv">1</span>,], <span class="at">col =</span> <span class="st">"navy"</span>)</span>
<span id="cb210-20"><a href="#cb210-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(diff2[<span class="dv">2</span>,], <span class="at">col =</span> <span class="st">"navy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="aggregate-by-attributes" class="level2" data-number="5.13">
<h2 data-number="5.13" class="anchored" data-anchor-id="aggregate-by-attributes"><span class="header-section-number">5.13</span> Aggregate by attributes</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-29-contents" aria-controls="callout-29" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-29" class="callout-29-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a>streets <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"streets"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/observations.csv"</span>)</span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(obs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Aggregation can be based purely on the attributes, treating the <code>sf</code> object as a data frame using the standard <code>aggregate()</code> function (but the geometry column will be lost). However, the <code>sf</code> package also extends the <code>aggregate()</code> function if you use an <code>sf</code> object as the first argument. Note that the nice formula notation is not possible in this case.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="fu">aggregate</span>(pop_est <span class="sc">~</span> continent, <span class="at">FUN =</span> sum, <span class="at">data =</span> World, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                continent    pop_est
1                  Africa 1306370215
2              Antarctica       4490
3                    Asia 4550277153
4                  Europe  745412452
5           North America  583756036
6                 Oceania   41204874
7 Seven seas (open ocean)        140
8           South America  427066661</code></pre>
</div>
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>world_agg <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(World[<span class="st">"pop_est"</span>], <span class="fu">list</span>(World<span class="sc">$</span>continent), <span class="at">FUN =</span> sum, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>world_agg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 8 features and 2 fields
Attribute-geometry relationships: aggregate (1), identity (1)
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: -180 ymin: -90 xmax: 180 ymax: 83.645
Geodetic CRS:  WGS 84
                  Group.1    pop_est                       geometry
1                  Africa 1306370215 MULTIPOLYGON (((-1.064 5.00...
2              Antarctica       4490 MULTIPOLYGON (((-59.572 -80...
3                    Asia 4550277153 MULTIPOLYGON (((59.181 22.9...
4                  Europe  745412452 MULTIPOLYGON (((-53.555 2.3...
5           North America  583756036 MULTIPOLYGON (((-155.688 18...
6                 Oceania   41204874 MULTIPOLYGON (((147.914 -43...
7 Seven seas (open ocean)        140 POLYGON ((68.867 -48.83, 68...
8           South America  427066661 MULTIPOLYGON (((-68.64 -55....</code></pre>
</div>
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(world_agg[,<span class="st">"pop_est"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-86-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note that the merging is not perfect since some country borders are not perfectly contiguous in the <code>World</code> data set.</p>
<p>Combining aggregation with intersections allows us to compute interesting parameters for some area. For example we can compute the total street length in buffers around some bird sightings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>obs_buff <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(obs[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">400</span>), <span class="dv">1</span>], <span class="at">dist =</span> <span class="dv">1000</span>)</span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>obs_buff<span class="sc">$</span>site <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a>streets_clip <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(obs_buff, <span class="fu">st_geometry</span>(streets))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="fu">aggregate</span>(<span class="fu">st_length</span>(streets_clip), <span class="at">by =</span> <span class="fu">list</span>(<span class="at">site =</span> streets_clip<span class="sc">$</span>site), <span class="at">FUN =</span> <span class="st">"sum"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  site            x
1    1 32446.10 [m]
2    2 44945.34 [m]
3    3 21131.22 [m]</code></pre>
</div>
</div>
<p>If you get an error about attributes when computing the intersection, you’ll need to first tell <code>sf</code> how the attributes of the data set should be considered (you should only get a warning with newer <code>sf</code> versions). Here we consider that the attributes are constant within each buffer. You can use the <code>st_agr()</code> function to do this. Use the following code before calling <code>st_intersection()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_agr</span>(obs_buff) <span class="ot">&lt;-</span> <span class="st">"constant"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="generate-sample-points" class="level2" data-number="5.14">
<h2 data-number="5.14" class="anchored" data-anchor-id="generate-sample-points"><span class="header-section-number">5.14</span> Generate sample points</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-30-contents" aria-controls="callout-30" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-30" class="callout-30-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>muni <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"municipalities"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>sempach <span class="ot">&lt;-</span> muni[muni<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Sempach"</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>If you need to generate points inside a polygon according to some sampling design, you’ll need the <code>st_sample()</code> function. Have a look at the help file to see all the sampling types available. In the next example we sample 100 points in Sempach based on two different designs: random and regular. Note that the final number of points can be slightly different when using a regular sampling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>samples_random <span class="ot">&lt;-</span> <span class="fu">st_sample</span>(sempach, <span class="dv">100</span>, <span class="at">type =</span> <span class="st">"random"</span>)</span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a>samples_regular <span class="ot">&lt;-</span> <span class="fu">st_sample</span>(sempach, <span class="dv">100</span>, <span class="at">type =</span> <span class="st">"regular"</span>)</span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-4"><a href="#cb223-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb223-5"><a href="#cb223-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(sempach), <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb223-6"><a href="#cb223-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(samples_random, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.5</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb223-7"><a href="#cb223-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(sempach), <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb223-8"><a href="#cb223-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(samples_regular, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.5</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-90-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If you need more sampling methods, you can also use the ones provided by the <code>spatstat.random</code> package (you’ll need to install it first). The next example shows how to use a simple sequential inhibition process (SSI) to sample 100 random points that are at least 50 meters apart. You can easily check that the constraint was applied by using the <code>st_distance()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>samples_ssi <span class="ot">&lt;-</span> <span class="fu">st_sample</span>(sempach, <span class="at">r =</span> <span class="dv">50</span>, <span class="at">n =</span> <span class="dv">100</span>, <span class="at">type =</span> <span class="st">"SSI"</span>)</span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>temp_dist <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(samples_ssi)</span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(temp_dist[temp_dist <span class="sc">&gt;</span> <span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 50.85489</code></pre>
</div>
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(sempach), <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(samples_ssi), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.5</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-91-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="convex-and-concave-hulls" class="level2" data-number="5.15">
<h2 data-number="5.15" class="anchored" data-anchor-id="convex-and-concave-hulls"><span class="header-section-number">5.15</span> Convex and concave hulls</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-31-contents" aria-controls="callout-31" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-31" class="callout-31-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a>muni <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"municipalities"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/observations.csv"</span>)</span>
<span id="cb227-4"><a href="#cb227-4" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(obs, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Sometimes you’ll need to use a polygon enclosing all your geometries. This is for example often used as a crude way to estimate an animal home range based on its sightings. Convex hulls are often called minimum convex polygons (MCP) in the ecological literature. Here we extract all the White Wagtail sightings in Neuenkirch and compute the respective minimum convex polygon. Note that we need to group the sightings into a single multipolygon using the <code>st_union()</code> or <code>st_combine()</code> function first. Otherwise we’ll get a separate convex hull for each point (and that’s rather useless since the convex hull of a single point is also a point).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a>obs_wagtail <span class="ot">&lt;-</span> obs[obs<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"White Wagtail"</span>,]</span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a>obs_wagtail_neuenkirch <span class="ot">&lt;-</span> obs_wagtail[muni[muni<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"Neuenkirch"</span>,],]</span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a>conv_hull <span class="ot">&lt;-</span> <span class="fu">st_convex_hull</span>(<span class="fu">st_combine</span>(obs_wagtail_neuenkirch))</span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(conv_hull, <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(obs_wagtail_neuenkirch), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-93-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If you want to compute separate convex hull for groups of points (based on some grouping factor such as individual identity), you need to use the <code>aggregate()</code> function. Let’s imagine we need separate convex hulls for the White Wagtail sightings in Sursee, Schenkon and Oberkirch. We first need to compute a spatial join to know the municipality of all the points, then we can aggregate and compute the three convex hulls.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>obs_wagtail <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(obs_wagtail, muni[muni<span class="sc">$</span>name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sursee"</span>, <span class="st">"Oberkirch"</span>, <span class="st">"Schenkon"</span>),])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a>obs_wagtail_agg <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(obs_wagtail, <span class="fu">list</span>(obs_wagtail<span class="sc">$</span>name<span class="fl">.1</span>), <span class="at">FUN =</span> length)</span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a>conv_hull <span class="ot">&lt;-</span> <span class="fu">st_convex_hull</span>(obs_wagtail_agg)</span>
<span id="cb231-3"><a href="#cb231-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-4"><a href="#cb231-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(conv_hull), <span class="at">col =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb231-5"><a href="#cb231-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(obs_wagtail_agg), <span class="at">pch =</span> <span class="dv">15</span><span class="sc">:</span><span class="dv">17</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-94-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If you’re computing home ranges and need a minimum convex polygon enclosing only a given percentage of the points (e.g.&nbsp;95%), have a look at the <code>mcp()</code> function in the <code>adehabitatHR</code> package.</p>
<p>Concave hulls (also known as alpha-shapes) are more flexible than convex hulls since the enclosing polygon can be, as the name suggests, concave and have holes. The concavity is controlled by the <code>ratio</code> argument: a value of 0 returns a maximally concave hull while a value of 1 returns a convex hull. Holes are controlled by the <code>allow_holes</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>conc_hull1 <span class="ot">&lt;-</span> <span class="fu">st_concave_hull</span>(<span class="fu">st_combine</span>(obs_wagtail_neuenkirch), <span class="at">ratio =</span> <span class="dv">0</span>)</span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a>conc_hull2 <span class="ot">&lt;-</span> <span class="fu">st_concave_hull</span>(<span class="fu">st_combine</span>(obs_wagtail_neuenkirch), <span class="at">ratio =</span> <span class="fl">0.5</span>)</span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb232-5"><a href="#cb232-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(conc_hull1, <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb232-6"><a href="#cb232-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(obs_wagtail_neuenkirch), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb232-7"><a href="#cb232-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(conc_hull2, <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb232-8"><a href="#cb232-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(obs_wagtail_neuenkirch), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-95-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="neighborhood-analyses" class="level2" data-number="5.16">
<h2 data-number="5.16" class="anchored" data-anchor-id="neighborhood-analyses"><span class="header-section-number">5.16</span> Neighborhood analyses</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-32-contents" aria-controls="callout-32" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-32" class="callout-32-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>muni <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/geodata.gpkg"</span>, <span class="st">"municipalities"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>We’ve already seen that the <code>sf</code> package provides some nice functions to study the topology of geometries. If you need more you can have a look at the <code>spdep</code> package which excels at neighborhood analyses. First we compute a neighbor list based on municipalities sharing a common boundary using the <code>poly2nb()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'spdep' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: spData</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>To access larger datasets in this package, install the spDataLarge
package with: `install.packages('spDataLarge',
repos='https://nowosad.github.io/drat/', type='source')`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>muni_neigh <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(muni)</span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a>muni_neigh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Neighbour list object:
Number of regions: 7 
Number of nonzero links: 22 
Percentage nonzero weights: 44.89796 
Average number of links: 3.142857 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(muni_neigh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Neighbour list object:
Number of regions: 7 
Number of nonzero links: 22 
Percentage nonzero weights: 44.89796 
Average number of links: 3.142857 
Link number distribution:

2 3 4 
2 2 3 
2 least connected regions:
1 7 with 2 links
3 most connected regions:
2 4 5 with 4 links</code></pre>
</div>
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(muni_neigh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 7
 $ : int [1:2] 2 3
 $ : int [1:4] 1 3 4 5
 $ : int [1:3] 1 2 5
 $ : int [1:4] 2 5 6 7
 $ : int [1:4] 2 3 4 6
 $ : int [1:3] 4 5 7
 $ : int [1:2] 4 6
 - attr(*, "class")= chr "nb"
 - attr(*, "region.id")= chr [1:7] "1" "2" "3" "4" ...
 - attr(*, "call")= language poly2nb(pl = muni)
 - attr(*, "type")= chr "queen"
 - attr(*, "snap")= num 0.01
 - attr(*, "sym")= logi TRUE
 - attr(*, "ncomp")=List of 2
  ..$ nc     : int 1
  ..$ comp.id: int [1:7] 1 1 1 1 1 1 1</code></pre>
</div>
</div>
<p>The output is stored as a list with the same ordering as the input data sets. For example we see that the municipality 1 (Neuenkirch) is neighboring municipalities 2 (Nottwil) and 3 (Sempach). Since it’s stored as a list, we can easily get the number of neighbors for all the municipalities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(muni_neigh, length)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2 4 3 4 4 3 2</code></pre>
</div>
</div>
<p>We can also compare the results of the <code>poly2nb()</code> function with the results of the <code>st_touches()</code> function provided by <code>sf</code>. Fortunately, the outputs are identical.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_touches</span>(muni)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 7, where the predicate
was `touches'
 1: 2, 3
 2: 1, 3, 4, 5
 3: 1, 2, 5
 4: 2, 5, 6, 7
 5: 2, 3, 4, 6
 6: 4, 5, 7
 7: 4, 6</code></pre>
</div>
</div>
<p>The <code>spdep</code> package provides plotting functions to visualize the neighbor lists. When working with polygons, we need to provide the coordinates of the centroids to the <code>plot()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>muni_centroids_coords <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(<span class="fu">st_centroid</span>(muni))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: st_centroid assumes attributes are constant over geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(muni))</span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muni_neigh, muni_centroids_coords, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(muni_centroids_coords, <span class="at">labels =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(muni), <span class="at">pos =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-100-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Looking for the closest neighbors to some feature is also a common neighborhood analysis (called K-nearest neighbors). Here we look for the two closest nearest neighbors of each municipality. To do that we use the <code>knearneigh()</code> function. This function only accepts point geometries so we need to use the centroids (and hence all the distances will be computed between centroids and not between the polygon boundaries). To get a neighbor list we use the <code>knn2nb()</code> function on the output of the <code>knearneigh()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>muni_knb <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(muni_centroids_coords, <span class="at">k =</span> <span class="dv">2</span>))</span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>muni_knb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Neighbour list object:
Number of regions: 7 
Number of nonzero links: 14 
Percentage nonzero weights: 28.57143 
Average number of links: 2 
Non-symmetric neighbours list</code></pre>
</div>
<div class="sourceCode cell-code" id="cb253"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is.symmetric.nb</span>(muni_knb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a>muni_knb2 <span class="ot">&lt;-</span> <span class="fu">make.sym.nb</span>(muni_knb)</span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a><span class="fu">is.symmetric.nb</span>(muni_knb2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>The resulting neighbor list will often be asymmetric. For example the two closest neighbors from municipality 1 (Neuenkirch) are municipalities 2 (Nottwil) and 3 (Sempach). However the two closest neighbors of municipality 2 are municipalities 4 and 5. Hence the link between municipalities 1 and 2 is asymmetric. We can use the <code>make.sym.nb()</code> function to make everything symmetric, but after applying this function we will have some municipalities with more than two neighbors. Let’s have a look at the plot of the two computed neighborhoods (symmetric and asymmetric).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(muni))</span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muni_knb, muni_centroids_coords, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">arrows =</span> <span class="cn">TRUE</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(muni))</span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muni_knb2, muni_centroids_coords, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">arrows =</span> <span class="cn">TRUE</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-102-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The K-nearest neighbor analysis also allows us to compute other quantities. For example we can easily compute the minimum distance so that each community has at least one neighbor. We use the <code>nbdists()</code> function to compute all the neighborhood distances, and since its output is a list we need to use the <code>unlist()</code> function to convert it to a vector.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a>muni_knb3 <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(muni_centroids_coords, <span class="at">k =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in knn2nb(knearneigh(muni_centroids_coords, k = 1)): neighbour object
has 2 sub-graphs</code></pre>
</div>
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>distances <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">nbdists</span>(muni_knb3, muni_centroids_coords))</span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a>(dist1nb <span class="ot">&lt;-</span> <span class="fu">max</span>(distances))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3860.315</code></pre>
</div>
</div>
<p>The <code>dnearneigh()</code> function is similar to the <code>knearneigh</code> function. It computes a list of all the neighbors within a specific distance. Similarly, the <code>dnearneigh()</code> function only accepts point geometries so we need to work with the centroids. Using this function we can also check that our computed minimum distance to have at least one neighbor is correct.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>dnb1 <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(muni_centroids_coords, <span class="at">d1 =</span> <span class="dv">0</span>, <span class="at">d2 =</span> <span class="fl">0.75</span> <span class="sc">*</span> dist1nb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in dnearneigh(muni_centroids_coords, d1 = 0, d2 = 0.75 * dist1nb):
neighbour object has 5 sub-graphs</code></pre>
</div>
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a>dnb2 <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(muni_centroids_coords, <span class="at">d1 =</span> <span class="dv">0</span>, <span class="at">d2 =</span> <span class="dv">1</span> <span class="sc">*</span> dist1nb)</span>
<span id="cb264-2"><a href="#cb264-2" aria-hidden="true" tabindex="-1"></a>dnb3 <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(muni_centroids_coords, <span class="at">d1 =</span> <span class="dv">0</span>, <span class="at">d2 =</span> <span class="fl">1.25</span> <span class="sc">*</span> dist1nb)</span>
<span id="cb264-3"><a href="#cb264-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-4"><a href="#cb264-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb264-5"><a href="#cb264-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(muni))</span>
<span id="cb264-6"><a href="#cb264-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dnb1, muni_centroids_coords, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb264-7"><a href="#cb264-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(muni))</span>
<span id="cb264-8"><a href="#cb264-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dnb2, muni_centroids_coords, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb264-9"><a href="#cb264-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(muni))</span>
<span id="cb264-10"><a href="#cb264-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dnb3, muni_centroids_coords, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-104-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Neighborhood lists provide an efficient way to store neighborhood information thanks to their sparse structure, but sometimes it’s nice to work with the full neighborhood matrix. You can use the <code>nb2mat()</code> function to get the matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nb2mat</span>(muni_neigh, <span class="at">style =</span> <span class="st">"B"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [,1] [,2] [,3] [,4] [,5] [,6] [,7]
1    0    1    1    0    0    0    0
2    1    0    1    1    1    0    0
3    1    1    0    0    1    0    0
4    0    1    0    0    1    1    1
5    0    1    1    1    0    1    0
6    0    0    0    1    1    0    1
7    0    0    0    1    0    1    0
attr(,"call")
nb2mat(neighbours = muni_neigh, style = "B")</code></pre>
</div>
</div>
<p>If you want to save the neighborhood as an <code>sf</code> line object, you can create the lines using the <code>nb2lines()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>neigh_sf <span class="ot">&lt;-</span> <span class="fu">nb2lines</span>(muni_neigh, <span class="at">coords =</span> <span class="fu">st_geometry</span>(muni_centroid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Neighborhood information is sometimes needed to fit more complex statistical models accounting for spatial autocorrelation (e.g.&nbsp;CAR models). You can fit some of these models in R, but sometimes you’ll need another software such as INLA or WinBUGS. The <code>spdep</code> package provide functions to export the neighborhood lists so that they can be used with these software.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a>nb_winbugs <span class="ot">&lt;-</span> <span class="fu">nb2WB</span>(muni_neigh)</span>
<span id="cb268-2"><a href="#cb268-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nb2INLA</span>(<span class="at">file =</span> <span class="st">"export/nbinla.txt"</span>, muni_neigh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="geocoding" class="level2" data-number="5.17">
<h2 data-number="5.17" class="anchored" data-anchor-id="geocoding"><span class="header-section-number">5.17</span> Geocoding</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-33-contents" aria-controls="callout-33" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-33" class="callout-33-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Sometimes the only geographical information you have is an address. The operation of translating an address into a geographical location (with coordinates) is called geocoding. For Switzerland, Swisstopo offers a free online tool to do that. To communicate with this tool we will use an API that is also documented by Swisstopo, with the help of the <code>httr2</code> package. First let’s define a function that will allow us to query the online geocoder.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'httr2' was built under R version 4.4.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>swissgeocode <span class="ot">&lt;-</span> <span class="cf">function</span>(address, <span class="at">nresults =</span> <span class="dv">3</span>){</span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># URL of the search service</span></span>
<span id="cb272-4"><a href="#cb272-4" aria-hidden="true" tabindex="-1"></a>    base <span class="ot">&lt;-</span> <span class="st">"https://api3.geo.admin.ch/"</span></span>
<span id="cb272-5"><a href="#cb272-5" aria-hidden="true" tabindex="-1"></a>    endpoint <span class="ot">&lt;-</span> <span class="st">"rest/services/api/SearchServer"</span></span>
<span id="cb272-6"><a href="#cb272-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-7"><a href="#cb272-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Encode address (needed because of spaces and exotic characters in the address)</span></span>
<span id="cb272-8"><a href="#cb272-8" aria-hidden="true" tabindex="-1"></a>    address_url <span class="ot">&lt;-</span> <span class="fu">URLencode</span>(address)</span>
<span id="cb272-9"><a href="#cb272-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-10"><a href="#cb272-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Request that will be sent to the server</span></span>
<span id="cb272-11"><a href="#cb272-11" aria-hidden="true" tabindex="-1"></a>    request_string <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base, endpoint, <span class="st">"?searchText="</span>, address_url, <span class="st">"&amp;type=locations"</span>, <span class="st">"&amp;limit="</span>, nresults, <span class="st">"&amp;sr=2056"</span>)</span>
<span id="cb272-12"><a href="#cb272-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-13"><a href="#cb272-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Send request</span></span>
<span id="cb272-14"><a href="#cb272-14" aria-hidden="true" tabindex="-1"></a>    req <span class="ot">&lt;-</span> <span class="fu">request</span>(request_string)</span>
<span id="cb272-15"><a href="#cb272-15" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> <span class="fu">req_perform</span>(req)</span>
<span id="cb272-16"><a href="#cb272-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert JSON to R objects</span></span>
<span id="cb272-17"><a href="#cb272-17" aria-hidden="true" tabindex="-1"></a>    resp_json <span class="ot">&lt;-</span> <span class="fu">resp_body_json</span>(resp, <span class="at">simplifyVector =</span> <span class="cn">TRUE</span>)</span>
<span id="cb272-18"><a href="#cb272-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-19"><a href="#cb272-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The address was not found</span></span>
<span id="cb272-20"><a href="#cb272-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(resp_json<span class="sc">$</span>results) <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">||</span> <span class="fu">length</span>(resp_json<span class="sc">$</span>results) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb272-21"><a href="#cb272-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">"The address could not be located."</span>)</span>
<span id="cb272-22"><a href="#cb272-22" aria-hidden="true" tabindex="-1"></a>        output <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">address_origin =</span> address, <span class="at">address_found =</span> <span class="cn">NA</span>, <span class="at">x =</span> <span class="cn">NA</span>, <span class="at">y =</span> <span class="cn">NA</span>, <span class="at">lat =</span> <span class="cn">NA</span>, <span class="at">lon =</span> <span class="cn">NA</span>, <span class="at">weight =</span> <span class="cn">NA</span>)</span>
<span id="cb272-23"><a href="#cb272-23" aria-hidden="true" tabindex="-1"></a>     }</span>
<span id="cb272-24"><a href="#cb272-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The address was found</span></span>
<span id="cb272-25"><a href="#cb272-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {</span>
<span id="cb272-26"><a href="#cb272-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge results in a data frame</span></span>
<span id="cb272-27"><a href="#cb272-27" aria-hidden="true" tabindex="-1"></a>        output <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(address)</span>
<span id="cb272-28"><a href="#cb272-28" aria-hidden="true" tabindex="-1"></a>        output <span class="ot">&lt;-</span> <span class="fu">cbind</span>(output, resp_json<span class="sc">$</span>results<span class="sc">$</span>attrs[, <span class="fu">c</span>(<span class="st">"detail"</span>, <span class="st">"y"</span>, <span class="st">"x"</span>, <span class="st">"lat"</span>, <span class="st">"lon"</span>)], resp_json<span class="sc">$</span>results<span class="sc">$</span>weight)</span>
<span id="cb272-29"><a href="#cb272-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The search service switches the coordinates axes (x=y and y=x)</span></span>
<span id="cb272-30"><a href="#cb272-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(output) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"address_origin"</span>, <span class="st">"address_found"</span>, <span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"lat"</span>, <span class="st">"lon"</span>, <span class="st">"weight"</span>)</span>
<span id="cb272-31"><a href="#cb272-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb272-32"><a href="#cb272-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(output)</span>
<span id="cb272-33"><a href="#cb272-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can test it with a random address.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb273"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a>test_address <span class="ot">&lt;-</span> <span class="st">"Seerose 1 6204 Sempach"</span></span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">swissgeocode</span>(test_address, <span class="at">nresults =</span> <span class="dv">5</span>)</span>
<span id="cb273-3"><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(results, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="st">"EPSG:2056"</span>)</span>
<span id="cb273-4"><a href="#cb273-4" aria-hidden="true" tabindex="-1"></a>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 5 features and 5 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 2657266 ymin: 1219688 xmax: 2657300 ymax: 1219722
Projected CRS: CH1903+ / LV95
          address_origin                               address_found      lat
1 Seerose 1 6204 Sempach   seerose 1 6204 sempach 1102 sempach ch lu 47.12601
2 Seerose 1 6204 Sempach seerose 1.1 6204 sempach 1102 sempach ch lu 47.12601
3 Seerose 1 6204 Sempach seerose 1.2 6204 sempach 1102 sempach ch lu 47.12593
4 Seerose 1 6204 Sempach seerose 3.1 6204 sempach 1102 sempach ch lu 47.12579
5 Seerose 1 6204 Sempach   seerose 2 6204 sempach 1102 sempach ch lu 47.12571
       lon weight                geometry
1 8.193561    100 POINT (2657282 1219722)
2 8.193356      4 POINT (2657266 1219722)
3 8.193375      4 POINT (2657268 1219713)
4 8.193802      4 POINT (2657300 1219698)
5 8.193670      1 POINT (2657290 1219688)</code></pre>
</div>
</div>
<p>If you need to geocode addresses outside of Switzerland, you can try the <code>geocode_OSM()</code> function in the <code>tmaptools</code> package. It uses a geocoder called Nominatim that is provided by OpenStreetMap. Also check the <code>tidygeocoder</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmaptools)</span>
<span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">geocode_OSM</span>(test_address, <span class="at">as.sf =</span> <span class="cn">TRUE</span>)</span>
<span id="cb275-3"><a href="#cb275-3" aria-hidden="true" tabindex="-1"></a>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 1 feature and 7 fields
Active geometry column: point
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 8.193418 ymin: 47.12631 xmax: 8.193418 ymax: 47.12631
Geodetic CRS:  WGS 84
                   query      lat      lon  lat_min  lat_max  lon_min  lon_max
1 Seerose 1 6204 Sempach 47.12631 8.193418 47.12598 47.12649 8.193269 8.193966
                            bbox                     point
1 POLYGON ((8.193269 47.12598... POINT (8.193418 47.12631)</code></pre>
</div>
</div>
</section>
<section id="crs-transformations" class="level2" data-number="5.18">
<h2 data-number="5.18" class="anchored" data-anchor-id="crs-transformations"><span class="header-section-number">5.18</span> CRS transformations</h2>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="If you start from here...">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-34-contents" aria-controls="callout-34" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you start from here…
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-34" class="callout-34-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Run the following code to load and create everything you’ll need to run the examples in this section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb277"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>If the data sets you’re using have different CRSs, it’s usually a good idea to transform some of them so that they all have the same CRS. We need the <code>st_transform()</code> function to do this. Sometimes we also say that we “project” the data to another CRS (however, transformations between geographic CRSs are not really projections).</p>
<p>Here we first check the CRS of the <code>World</code> data set using the <code>st_crs()</code> function and compute a graticule (grid). Then we project the data set to three different projected CRSs, the Swiss CRS, the Equal Earth projection and the Robinson projection. If we use a CRS with an EPSG number, we can also use the integer value directly (without specifying “EPSG:”). However it’s a good habit to always specify the provider to avoid confusions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(World)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coordinate Reference System:
  User input: EPSG:4326 
  wkt:
GEOGCRS["WGS 84",
    ENSEMBLE["World Geodetic System 1984 ensemble",
        MEMBER["World Geodetic System 1984 (Transit)"],
        MEMBER["World Geodetic System 1984 (G730)"],
        MEMBER["World Geodetic System 1984 (G873)"],
        MEMBER["World Geodetic System 1984 (G1150)"],
        MEMBER["World Geodetic System 1984 (G1674)"],
        MEMBER["World Geodetic System 1984 (G1762)"],
        MEMBER["World Geodetic System 1984 (G2139)"],
        ELLIPSOID["WGS 84",6378137,298.257223563,
            LENGTHUNIT["metre",1]],
        ENSEMBLEACCURACY[2.0]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["geodetic latitude (Lat)",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["geodetic longitude (Lon)",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    USAGE[
        SCOPE["Horizontal component of 3D system."],
        AREA["World."],
        BBOX[-90,-180,90,180]],
    ID["EPSG",4326]]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a>grat <span class="ot">&lt;-</span> <span class="fu">st_graticule</span>()</span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a>world_ch <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(World, <span class="st">"EPSG:2056"</span>)</span>
<span id="cb280-3"><a href="#cb280-3" aria-hidden="true" tabindex="-1"></a>grat_ch <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(grat, <span class="st">"EPSG:2056"</span>)</span>
<span id="cb280-4"><a href="#cb280-4" aria-hidden="true" tabindex="-1"></a>world_equal <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(World, <span class="st">"EPSG:8857"</span>)</span>
<span id="cb280-5"><a href="#cb280-5" aria-hidden="true" tabindex="-1"></a>grat_equal <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(grat, <span class="st">"EPSG:8857"</span>)</span>
<span id="cb280-6"><a href="#cb280-6" aria-hidden="true" tabindex="-1"></a>world_rob <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(World, <span class="st">"ESRI:54030"</span>)</span>
<span id="cb280-7"><a href="#cb280-7" aria-hidden="true" tabindex="-1"></a>grat_rob <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(grat, <span class="st">"ESRI:54030"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we plot that data, we first see that, not surprisingly, the Swiss CRS is not adapted at all for global data, and that the Equal Earth and Robinson projections give a pleasing result. Both of these projections are good choices for world maps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb281"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb281-2"><a href="#cb281-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(World), <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb281-3"><a href="#cb281-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(grat), <span class="at">col =</span> <span class="st">"lightgrey"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb281-4"><a href="#cb281-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(world_ch), <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb281-5"><a href="#cb281-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(grat_ch), <span class="at">col =</span> <span class="st">"lightgrey"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb281-6"><a href="#cb281-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(world_equal), <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb281-7"><a href="#cb281-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(grat_equal), <span class="at">col =</span> <span class="st">"lightgrey"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb281-8"><a href="#cb281-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(world_rob), <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb281-9"><a href="#cb281-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(grat_rob), <span class="at">col =</span> <span class="st">"lightgrey"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="vectors_tips_files/figure-html/unnamed-chunk-114-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>st_crs()</code> function is used to query or assign a CRS, but it does not perform any CRS transformation!</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Exercise (5 minutes)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise (5 minutes)
</div>
</div>
<div class="callout-body-container callout-body">
<p>The Bonne projection is one of the most beautiful projection available. To understand why, try to make a world map with a graticule using this projection.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>world_bonne <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(World, <span class="st">"ESRI:54024"</span>)</span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a>grat_bonne <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(grat, <span class="st">"ESRI:54024"</span>)</span>
<span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-4"><a href="#cb282-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(world_bonne), <span class="at">col =</span> <span class="st">"grey90"</span>)</span>
<span id="cb282-5"><a href="#cb282-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(grat_bonne), <span class="at">col =</span> <span class="st">"lightgrey"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>


<div id="refs" class="references csl-bib-body" role="list" style="display: none">
<div id="ref-pebesma_lwgeom_2023" class="csl-entry" role="listitem">
<div class="csl-left-margin">1. </div><div class="csl-right-inline">Pebesma E. Lwgeom: <span>Bindings</span> to <span>Selected</span> liblwgeom <span>Functions</span> for <span>Simple</span> <span>Features</span>. Published online 2023. <a href="https://github.com/r-spatial/lwgeom/">https://github.com/r-spatial/lwgeom/</a></div>
</div>
<div id="ref-lovelace_geocomputation_2025" class="csl-entry" role="listitem">
<div class="csl-left-margin">2. </div><div class="csl-right-inline">Lovelace R, Nowosad J, Muenchow J. <em>Geocomputation with <span>R</span></em>. Second edition. CRC Press 2025.</div>
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./coordinate_reference_systems.html" class="pagination-link" aria-label="Coordinate reference systems">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Coordinate reference systems</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./rasters_tips.html" class="pagination-link" aria-label="Tips and tricks for rasters">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Tips and tricks for rasters</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2025, Jérôme Guélat</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>